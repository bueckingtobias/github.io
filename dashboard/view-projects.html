<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Projekte / Bau · Dashboard</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="theme-color" content="#0b1220" />

  <link rel="stylesheet" href="./shell.css" />

  <script src="./auth.js"></script>
  <script>Auth.requireAuth({ loginUrl:"./login.html" });</script>

  <script src="./shell.js"></script>
  <script src="./excel-loader.js"></script>

  <style>
    html,body{ overflow-x:hidden !important; }
    .proj-grid{ display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:var(--gap); min-width:0; }
    .span12{ grid-column:span 12; min-width:0; }
    .span6{ grid-column:span 6; min-width:0; }
    @media (max-width:900px){ .span6{ grid-column:span 12; } }
    .module-slot{ width:100%; min-width:0; }

    .alert{
      border-radius: 14px;
      border:1px solid rgba(248,113,113,.35);
      background: rgba(248,113,113,.08);
      padding: 12px 14px;
      color: rgba(226,232,240,.92);
      font-size: 12px;
      line-height: 1.35;
      overflow-wrap:anywhere;
      white-space: pre-wrap;
    }
    .alert strong{ font-weight: 950; }
  </style>
</head>

<body>
  <div id="app"></div>

  <template id="pageTpl">
    <section class="proj-grid">

      <!-- Gesamt -->
      <section class="span12">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Gesamtübersicht</div>
              <div class="card-sub">Budget · Zahlungen · Fortschritt</div>
            </div>
          </div>
          <div class="card-body">
            <div class="module-slot" id="slotProjGesamt"></div>
          </div>
        </div>
      </section>

      <!-- 10 Gewerke -->
      <div id="gewerkCards" style="display:contents;"></div>

    </section>
  </template>

  <script>
    (async function(){
      Shell.mount({ active:"./view-projects.html", title:"Projekte / Bau", sub:"Gesamt + Gewerke" });

      function showError(el, title, err){
        el.innerHTML = "";
        const box = document.createElement("div");
        box.className = "alert";
        box.innerHTML = `<strong>${title}</strong>\n${err && err.message ? err.message : String(err)}`;
        el.appendChild(box);
      }

      function loadCssOnce(href){
        if(document.querySelector('link[data-href="'+href+'"]')) return Promise.resolve();
        return new Promise((resolve,reject)=>{
          const l=document.createElement("link");
          l.rel="stylesheet"; l.href=href; l.dataset.href=href;
          l.onload=resolve;
          l.onerror=()=>reject(new Error("CSS nicht geladen: " + href));
          document.head.appendChild(l);
        });
      }

      function loadJsOnce(src){
        if(document.querySelector('script[data-src="'+src+'"]')) return Promise.resolve();
        return new Promise((resolve,reject)=>{
          const s=document.createElement("script");
          s.src=src; s.defer=true; s.dataset.src=src;
          s.onload=resolve;
          s.onerror=()=>reject(new Error("JS nicht geladen: " + src));
          document.head.appendChild(s);
        });
      }

      async function loadHtmlInto(url, el){
        const r = await fetch(url, { cache:"no-store" });
        if(!r.ok) throw new Error("HTML nicht geladen: " + url + " (HTTP " + r.status + ")");
        el.innerHTML = await r.text();
      }

      async function mountSingleModule({ slotEl, html, css, js, globalName, data }){
        await loadHtmlInto(html, slotEl);
        await loadCssOnce(css);
        await loadJsOnce(js);

        const mod = window[globalName];
        if(!mod || typeof mod.render !== "function"){
          throw new Error("Modul nicht verfügbar: window." + globalName + ".render()");
        }
        mod.render(slotEl, data);
      }

      // 1) Excel laden
      const slotGesamt = document.getElementById("slotProjGesamt");
      try{
        await ExcelLoader.load("./Dashboard.xlsx");
      }catch(e){
        showError(slotGesamt, "Daten konnten nicht geladen werden.", e);
        return;
      }

      // 2) Daten holen
      const projectGesamt = window.IMMO_DATA?.projects?.gesamt || {};
      const gewerkeRaw = window.IMMO_DATA?.projects?.gewerke;

      const gewerke = Array.isArray(gewerkeRaw) ? gewerkeRaw : [];

      // Hard requirement: Gesamtmodul erwartet ARRAY
      if(!gewerke.length){
        showError(slotGesamt, "Keine Gewerke-Daten gefunden.", new Error("Sheet 'Projects_Gewerke' ist leer oder falsch benannt."));
        return;
      }

      // Modul filtert nach "Aktiv (Ja/Nein)". Falls nicht vorhanden/leer: als aktiv behandeln.
      const allRowsForGesamt = gewerke.map(r => {
        const out = Object.assign({}, r || {});
        if(out["Aktiv (Ja/Nein)"] == null || String(out["Aktiv (Ja/Nein)"]).trim() === ""){
          out["Aktiv (Ja/Nein)"] = "Ja";
        }
        // Optional: Projektname fallback aus Projects_Gesamt
        if((out.Projekt == null || String(out.Projekt).trim()==="") && projectGesamt.Projekt){
          out.Projekt = projectGesamt.Projekt;
        }
        return out;
      });

      // 3) Module-Assets laden & rendern
      try{
        await mountSingleModule({
          slotEl: slotGesamt,
          html: "./gewerk-gesamt-modul.html",
          css: "./gewerk-gesamt-modul.css",
          js:  "./gewerk-gesamt-modul.js",
          globalName: "GewerkGesamtModul",
          data: allRowsForGesamt   // <-- ARRAY (FIX)
        });
      }catch(e){
        showError(slotGesamt, "Modul konnte nicht geladen werden.", e);
        return;
      }

      // 4) 10 Gewerke Module
      const wrap = document.getElementById("gewerkCards");
      wrap.innerHTML = "";

      try{
        await loadCssOnce("./gewerk-modul.css");
        await loadJsOnce("./gewerk-modul.js");
      }catch(e){
        const fail = document.createElement("section");
        fail.className = "span12";
        fail.innerHTML = `<div class="card"><div class="card-body"><div class="alert"><strong>Gewerk-Module konnten nicht geladen werden.</strong>\n${e.message}</div></div></div>`;
        wrap.appendChild(fail);
        return;
      }

      for(let i=0;i<10;i++){
        const g = allRowsForGesamt[i];

        const sec = document.createElement("section");
        sec.className = "span6";
        sec.innerHTML = `
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">${g ? (g.Gewerk || ("Gewerk " + (i+1))) : ("Gewerk " + (i+1))}</div>
                <div class="card-sub">${g ? (g.Projekt || projectGesamt.Projekt || "") : (projectGesamt.Projekt || "")}</div>
              </div>
            </div>
            <div class="card-body"><div class="module-slot" id="slotG${i}"></div></div>
          </div>
        `;
        wrap.appendChild(sec);

        const slot = sec.querySelector(".module-slot");

        if(!g){
          showError(slot, "Keine Daten vorhanden.", new Error("Sheet 'Projects_Gewerke' hat weniger als 10 Zeilen."));
          continue;
        }

        try{
          await loadHtmlInto("./gewerk-modul.html", slot);
          if(!window.GewerkModul || typeof window.GewerkModul.render !== "function"){
            throw new Error("Modul nicht verfügbar: window.GewerkModul.render()");
          }
          window.GewerkModul.render(slot, g);
        }catch(e){
          showError(slot, "Modul konnte nicht geladen werden.", e);
        }
      }
    })();
  </script>
</body>
</html>