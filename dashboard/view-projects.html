<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dashboard ¬∑ Projekte</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="theme-color" content="#0b1220" />

  <script>window.__VER="20251216-Projects-1";</script>

  <link rel="stylesheet" href="./shell.css?v=20251216-Projects-1" />

  <link rel="stylesheet" href="./gewerk-gesamt-modul.css?v=20251216-Projects-1" />
  <link rel="stylesheet" href="./gewerk-modul.css?v=20251216-Projects-1" />

  <style>
    html, body { overflow-x: hidden; }

    .projects-wrap{
      display:flex;
      flex-direction:column;
      gap: 14px;
      min-width:0;
    }

    /* oben breit (wie 2 Module nebeneinander) */
    .projects-top{
      width:100%;
      min-width:0;
    }

    /* darunter: iPad/desktop 2 Spalten, mobile 1 Spalte */
    .projects-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 14px;
      min-width:0;
      align-items:stretch;
    }
    @media (max-width: 900px){
      .projects-grid{
        grid-template-columns: 1fr;
      }
    }

    .module-host{
      min-width:0;
      overflow:hidden;
    }

    .module-error{
      font-size:12px;
      color: rgba(226,232,240,.78);
      line-height:1.35;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.45);
      color: rgba(226,232,240,.82);
      font-size:11px;
      white-space:nowrap;
      max-width:56vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }
  </style>
</head>

<body>
<div class="app">

  <!-- Sidebar (identisch) -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-dot"></div>
      <div>
        <div class="brand-title">B√ºcking Dashboard</div>
        <div class="brand-sub">Immobilien ¬∑ Projekte ¬∑ KPIs</div>
      </div>
    </div>

    <nav class="nav">
      <a href="./view-home.html">
        <div class="nav-ic">‚åÇ</div>
        <div class="nav-txt">
          <div class="nav-title">Home</div>
          <div class="nav-sub">√úbersicht</div>
        </div>
      </a>

      <div class="nav-label">Projekte</div>

      <a href="./view-projects.html" class="active">
        <div class="nav-ic">üèó</div>
        <div class="nav-txt">
          <div class="nav-title">Projekte / Bau</div>
          <div class="nav-sub">Gesamt + Gewerke</div>
        </div>
      </a>

      <a href="./view-finance.html">
        <div class="nav-ic">‚Ç¨</div>
        <div class="nav-txt">
          <div class="nav-title">Finanzen</div>
          <div class="nav-sub">Cashflow, Budget</div>
        </div>
      </a>

      <div class="nav-label">Tools</div>
      <a href="./admin-data.html">
        <div class="nav-ic">‚úé</div>
        <div class="nav-txt">
          <div class="nav-title">Admin Daten</div>
          <div class="nav-sub">Pflege Master</div>
        </div>
      </a>
    </nav>

    <div class="sidebar-footer">
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </aside>

  <!-- Main -->
  <section class="main">
    <header class="topbar">
      <div class="page-title">
        <h1>Projekte / Bau</h1>
        <div>Gesamt√ºbersicht + 10 Gewerke</div>
      </div>
      <div class="top-right">
        <span class="chip" id="clockTop">‚Äî</span>
        <span class="chip" id="dataChip">Daten: ‚Äî</span>
      </div>
    </header>

    <main class="content">
      <div class="container" style="max-width:1400px;">
        <div class="projects-wrap">

          <!-- TOP: Gesamtmodul -->
          <section class="card projects-top">
            <div class="card-header">
              <div>
                <div class="card-title">Gesamt√ºbersicht</div>
                <div class="card-sub">gewerk-gesamt-modul</div>
              </div>
            </div>
            <div class="card-body module-host" id="gesamtHost"></div>
          </section>

          <!-- GRID: 10x Gewerk-Modul -->
          <section class="projects-grid" id="gewerkeGrid">
            <!-- Module injected per JS -->
          </section>

        </div>
      </div>
    </main>
  </section>
</div>

<!-- DataLoader (loads master-data.js automatically if missing) -->
<script src="./data-loader.js?v=20251216-Projects-1"></script>

<!-- Module scripts -->
<script src="./gewerk-gesamt-modul.js?v=20251216-Projects-1"></script>
<script src="./gewerk-modul.js?v=20251216-Projects-1"></script>

<script>
(async function(){

  // Clock
  const clockTop = document.getElementById("clockTop");
  function tick(){
    const d = new Date();
    clockTop.textContent = d.toLocaleString("de-DE",{weekday:"short",hour:"2-digit",minute:"2-digit"});
  }
  tick(); setInterval(tick,15000);

  // Logout
  document.getElementById("logoutBtn").onclick = () => {
    try { localStorage.clear(); } catch {}
    location.href = "./index.html";
  };

  // Inject helper
  async function inject(hostEl, fragmentPath){
    const url = fragmentPath + "?v=" + encodeURIComponent(window.__VER);
    try{
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error(res.status + " " + res.statusText);
      hostEl.innerHTML = await res.text();
    }catch(e){
      hostEl.innerHTML = `
        <div class="module-error">
          <b>Modul konnte nicht geladen werden:</b><br/>
          ${fragmentPath}<br/>
          ${String(e && e.message ? e.message : e)}
        </div>`;
    }
  }

  // 1) Inject Gesamtmodul
  const gesamtHost = document.getElementById("gesamtHost");
  await inject(gesamtHost, "./gewerk-gesamt-modul.html");

  // 2) Prepare 10 containers for Gewerk modules (HTML injected per tile)
  const grid = document.getElementById("gewerkeGrid");
  grid.innerHTML = "";
  const tiles = [];
  for (let i=0;i<10;i++){
    const tile = document.createElement("section");
    tile.className = "card module-host";
    tile.innerHTML = `
      <div class="card-header">
        <div>
          <div class="card-title">Gewerk</div>
          <div class="card-sub">gewerk-modul</div>
        </div>
      </div>
      <div class="card-body module-host" data-idx="${i}"></div>
    `;
    grid.appendChild(tile);
    tiles.push(tile.querySelector(".card-body"));
  }

  // 3) Inject Gewerk-Modul HTML into each tile (same file, reused)
  for (const host of tiles){
    await inject(host, "./gewerk-modul.html");
  }

  // 4) Load data
  await DataLoader.load();

  // 5) Data chip
  const chip = document.getElementById("dataChip");
  const meta = window.IMMO_DATA_META || {};
  const hasMaster = !!window.IMMO_MASTER_DATA;
  const gewerkeCount = Array.isArray(window.IMMO_DATA?.projects?.gewerke) ? window.IMMO_DATA.projects.gewerke.length : 0;

  if (meta.ok && hasMaster){
    chip.textContent = `Master:OK ¬∑ Loader:OK ¬∑ Gewerke:${gewerkeCount} ¬∑ v ${meta.version || "‚Äî"}`;
  } else {
    chip.textContent = `Master:FAIL ¬∑ Loader:OK ¬∑ Gewerke:${gewerkeCount} ¬∑ ${meta.reason || ""}`;
  }

  // 6) Render Gesamt
  if (window.GewerkGesamtModul?.render) {
    window.GewerkGesamtModul.render(gesamtHost);
  }

  // 7) Render Einzelmodule: jede Kachel bekommt Index ‚Üí entsprechendes Gewerk
  tiles.forEach((host, idx) => {
    if (window.GewerkModul?.render) {
      window.GewerkModul.render(host, { index: idx });
    }
  });

  // iPad retry
  setTimeout(() => {
    if (window.GewerkGesamtModul?.render) window.GewerkGesamtModul.render(gesamtHost);
    tiles.forEach((host, idx) => {
      if (window.GewerkModul?.render) window.GewerkModul.render(host, { index: idx });
    });
  }, 250);

})();
</script>

</body>
</html>