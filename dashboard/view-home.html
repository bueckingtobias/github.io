<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dashboard ¬∑ Home</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="theme-color" content="#0b1220" />

  <link rel="stylesheet" href="./shell.css" />
  <link rel="stylesheet" href="./home-kpi-modul.css" />
</head>

<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Navigation">
      <div class="brand">
        <div class="brand-dot"></div>
        <div style="min-width:0">
          <div class="brand-title">B√ºcking Dashboard</div>
          <div class="brand-sub">Immobilien ¬∑ Projekte ¬∑ KPIs</div>
        </div>
      </div>

      <nav class="nav" id="nav">
        <a href="./view-home.html" data-title="Home" data-sub="Wetter ¬∑ Kalender ¬∑ KPIs" class="active">
          <div class="nav-ic">‚åÇ</div>
          <div class="nav-txt">
            <div class="nav-title">Home</div>
            <div class="nav-sub">Wetter ¬∑ Kalender ¬∑ KPIs</div>
          </div>
        </a>

        <div class="nav-label">Projekte</div>

        <a href="./view-projects.html" data-title="Projekte / Bau" data-sub="Module: Gesamt + Gewerke">
          <div class="nav-ic">üèó</div>
          <div class="nav-txt">
            <div class="nav-title">Projekte / Bau</div>
            <div class="nav-sub">Module: Gesamt + Gewerke</div>
          </div>
        </a>

        <a href="./view-finance.html" data-title="Finanzen" data-sub="Cashflow, Mieten & Pacht, OP, Reserven, Budget">
          <div class="nav-ic">‚Ç¨</div>
          <div class="nav-txt">
            <div class="nav-title">Finanzen</div>
            <div class="nav-sub">Cashflow, Mieten & Pacht, OP, Reserven</div>
          </div>
        </a>

        <a href="./view-vermietung.html" data-title="Vermietung" data-sub="Leerstand, Mieten, Anfragen">
          <div class="nav-ic">üè†</div>
          <div class="nav-txt">
            <div class="nav-title">Vermietung</div>
            <div class="nav-sub">Leerstand, Mieten, Anfragen</div>
          </div>
        </a>

        <div class="nav-label">Tools</div>

        <a href="./admin.html" data-title="Admin" data-sub="Uploads, Settings, Debug">
          <div class="nav-ic">‚öô</div>
          <div class="nav-txt">
            <div class="nav-title">Admin</div>
            <div class="nav-sub">Uploads, Settings, Debug</div>
          </div>
        </a>
      </nav>

      <div class="sidebar-footer">
        <span class="chip" id="clockSide">‚Äî</span>
        <span class="chip">online</span>
      </div>
    </aside>

    <!-- Main -->
    <section class="main">
      <header class="topbar">
        <div class="page-title">
          <h1 id="pageTitle">Home</h1>
          <div id="pageSub">Wetter ¬∑ Kalender ¬∑ KPIs</div>
        </div>
        <div class="top-right">
          <span class="chip" id="clockTop">‚Äî</span>
        </div>
      </header>

      <main class="content">
        <div class="container" style="max-width: 1300px;">
          <!-- Top Row: Wetter + Kalender (Platzhalter ‚Äì bleiben bei dir wie bereits gebaut) -->
          <section class="grid" style="align-items:stretch;">
            <section class="card" style="grid-column: span 6; min-height: 240px;">
              <div class="card-header">
                <div>
                  <div class="card-title">Wetter</div>
                  <div class="card-sub">Apple-Style Widget (bleibt bei dir wie gebaut).</div>
                </div>
              </div>
              <div class="card-body">
                <div style="color:rgba(226,232,240,.70);font-size:12px;">
                  Wetter-Modul kommt aus deiner bestehenden Datei/Einbindung.
                </div>
              </div>
            </section>

            <section class="card" style="grid-column: span 6; min-height: 240px;">
              <div class="card-header">
                <div>
                  <div class="card-title">Kalender</div>
                  <div class="card-sub">Apple-Style Monatsansicht (bleibt bei dir wie gebaut).</div>
                </div>
              </div>
              <div class="card-body">
                <div style="color:rgba(226,232,240,.70);font-size:12px;">
                  Kalender-Modul kommt aus deiner bestehenden Datei/Einbindung.
                </div>
              </div>
            </section>

            <!-- KPI Modul full width -->
            <section class="card" style="grid-column: span 12;">
              <div class="card-header">
                <div>
                  <div class="card-title">KPIs</div>
                  <div class="card-sub">6 Monate R√ºckblick ¬∑ aktueller Monat blau ¬∑ 3 Monate Forecast (gr√ºn/rot nach Trend).</div>
                </div>
              </div>
              <div class="card-body" style="padding:0;">
                <div id="homeKpiMount" class="home-kpi-mount"></div>
              </div>
            </section>
          </section>
        </div>
      </main>
    </section>
  </div>

  <!-- Dein bestehender Excel-Loader bleibt wie er ist -->
  <!-- Beispiel: <script src="./excel-loader.js"></script> -->
  <script src="./excel-loader.js"></script>

  <!-- KPI Modul -->
  <script src="./home-kpi-modul.js"></script>

  <script>
    (function(){
      // Clock
      const clockTop = document.getElementById("clockTop");
      const clockSide = document.getElementById("clockSide");

      function tick(){
        const d = new Date();
        const t = d.toLocaleString("de-DE", { weekday:"short", year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
        if(clockTop) clockTop.textContent = t;
        if(clockSide) clockSide.textContent = t;
      }
      tick(); setInterval(tick, 15000);

      // Render KPIs when data is ready
      const mount = document.getElementById("homeKpiMount");

      function tryRender(){
        if (!mount) return;

        if (!window.HomeKpiModul || typeof window.HomeKpiModul.render !== "function") {
          mount.innerHTML = '<div style="padding:14px;color:rgba(226,232,240,.75);font-size:12px;">KPI Modul nicht geladen.</div>';
          return;
        }

        // Module can pull data via adapter internally
        window.HomeKpiModul.render(mount);
      }

      // 1) If your loader fires an event (recommended)
      window.addEventListener("immo:data-ready", tryRender);
      window.addEventListener("dashboard:data-ready", tryRender);

      // 2) Fallback: poll for up to ~2s until loader populated globals
      let tries = 0;
      const poll = setInterval(() => {
        tries++;
        tryRender();
        // stop once we actually rendered content
        if (mount && mount.dataset.rendered === "1") { clearInterval(poll); }
        if (tries > 20) { clearInterval(poll); }
      }, 120);

      // Highlight nav
      const path = (location.pathname || "").toLowerCase();
      const nav = document.getElementById("nav");
      if(nav){
        const links = Array.from(nav.querySelectorAll("a[href]"));
        links.forEach(a => a.classList.remove("active"));
        const match = links.find(a => path.endsWith((a.getAttribute("href")||"").toLowerCase().replace("./","/"))) || links[0];
        if(match) match.classList.add("active");
      }
    })();
  </script>
</body>
</html>
