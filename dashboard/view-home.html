<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dashboard ¬∑ Home</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="theme-color" content="#0b1220" />

  <!-- Cache-Buster (hochz√§hlen wenn iPad Safari cached) -->
  <script>
    window.__VER = "20251214-Home-1";
  </script>

  <!-- ===== GLOBAL / SHELL ===== -->
  <link rel="stylesheet" href="./shell.css?v=20251214-Home-1" />

  <!-- ===== HOME MODULE STYLES (unver√§ndert) ===== -->
  <link rel="stylesheet" href="./home-weather-modul.css?v=20251214-Home-1" />
  <link rel="stylesheet" href="./home-calendar-modul.css?v=20251214-Home-1" />
  <link rel="stylesheet" href="./home-kpis-modul.css?v=20251214-Home-1" />

  <style>
    html, body { overflow-x: hidden; }

    .home-grid{
      display:grid;
      grid-template-columns: repeat(12, minmax(0,1fr));
      gap: 12px;
      align-items:stretch;
      min-width:0;
    }
    .col-6{ grid-column: span 6; min-width:0; }
    .col-12{ grid-column: span 12; min-width:0; }

    @media (max-width: 900px){
      .col-6{ grid-column: span 12; }
    }

    /* gleiche H√∂he oben (iPad) */
    .home-top{
      height: 280px;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    @media (max-width: 900px){
      .home-top{ height:auto; }
    }

    .module-host{
      flex:1 1 auto;
      min-height:0;
      overflow:hidden;
    }

    .module-error{
      font-size:12px;
      color: rgba(226,232,240,.78);
      line-height:1.35;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
    }
  </style>
</head>

<body>
<div class="app">

  <!-- ========================================================= -->
  <!-- SIDEBAR (einheitlich + Logout) -->
  <!-- ========================================================= -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-dot"></div>
      <div>
        <div class="brand-title">B√ºcking Dashboard</div>
        <div class="brand-sub">Immobilien ¬∑ Projekte ¬∑ KPIs</div>
      </div>
    </div>

    <nav class="nav">
      <a href="./view-home.html" class="active">
        <div class="nav-ic">‚åÇ</div>
        <div class="nav-txt">
          <div class="nav-title">Home</div>
          <div class="nav-sub">√úbersicht</div>
        </div>
      </a>

      <div class="nav-label">Projekte</div>

      <a href="./view-projects.html">
        <div class="nav-ic">üèó</div>
        <div class="nav-txt">
          <div class="nav-title">Projekte / Bau</div>
          <div class="nav-sub">Gesamt + Gewerke</div>
        </div>
      </a>

      <a href="./view-finance.html">
        <div class="nav-ic">‚Ç¨</div>
        <div class="nav-txt">
          <div class="nav-title">Finanzen</div>
          <div class="nav-sub">Cashflow, Budget</div>
        </div>
      </a>

      <div class="nav-label">Tools</div>

      <a href="./admin-data.html">
        <div class="nav-ic">‚úé</div>
        <div class="nav-txt">
          <div class="nav-title">Admin Daten</div>
          <div class="nav-sub">Pflege IMMO_DATA</div>
        </div>
      </a>
    </nav>

    <div class="sidebar-footer">
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </aside>

  <!-- ========================================================= -->
  <!-- MAIN -->
  <!-- ========================================================= -->
  <section class="main">

    <header class="topbar">
      <div class="page-title">
        <h1>Home</h1>
        <div>Wetter ¬∑ Kalender ¬∑ KPIs</div>
      </div>
      <div class="top-right">
        <span class="chip" id="clockTop">‚Äî</span>
      </div>
    </header>

    <main class="content">
      <div class="container" style="max-width:1300px;">

        <section class="home-grid">
          <!-- WETTER -->
          <section class="card col-6 home-top">
            <div class="card-header">
              <div>
                <div class="card-title">Wetter</div>
                <div class="card-sub">home-weather-modul</div>
              </div>
            </div>
            <div class="card-body module-host" id="weatherHost"></div>
          </section>

          <!-- KALENDER -->
          <section class="card col-6 home-top">
            <div class="card-header">
              <div>
                <div class="card-title">Kalender</div>
                <div class="card-sub">home-calendar-modul</div>
              </div>
            </div>
            <div class="card-body module-host" id="calendarHost"></div>
          </section>

          <!-- KPIs -->
          <section class="card col-12">
            <div class="card-header">
              <div>
                <div class="card-title">KPIs</div>
                <div class="card-sub">home-kpis-modul</div>
              </div>
            </div>
            <div class="card-body module-host" id="kpisHost"></div>
          </section>
        </section>

      </div>
    </main>
  </section>
</div>

<!-- ========================================================= -->
<!-- DATA SOURCE (A) -->
<!-- ========================================================= -->
<script src="./master-data.js?v=20251214-Home-1"></script>
<script src="./data-loader.js?v=20251214-Home-1"></script>

<!-- ========================================================= -->
<!-- MODULE SCRIPTS (unver√§ndert) -->
<!-- ========================================================= -->
<script src="./home-weather-modul.js?v=20251214-Home-1"></script>
<script src="./home-calendar-modul.js?v=20251214-Home-1"></script>
<script src="./home-kpis-modul.js?v=20251214-Home-1"></script>

<!-- ========================================================= -->
<!-- BOOTSTRAP -->
<!-- ========================================================= -->
<script>
(async function(){

  /* Clock */
  const clockTop = document.getElementById("clockTop");
  function tick(){
    const d = new Date();
    clockTop.textContent = d.toLocaleString("de-DE", {
      weekday:"short", hour:"2-digit", minute:"2-digit"
    });
  }
  tick(); setInterval(tick, 15000);

  /* Logout (nutzt deinen bestehenden Login-State: safe hard logout) */
  document.getElementById("logoutBtn").onclick = () => {
    try { localStorage.clear(); } catch {}
    location.href = "./index.html";
  };

  /* Helper: fetch module fragment into host */
  async function injectFragment(hostId, fragmentPath){
    const host = document.getElementById(hostId);
    if (!host) return;

    const url = fragmentPath + (fragmentPath.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(window.__VER || "1");
    try{
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(res.status + " " + res.statusText);
      host.innerHTML = await res.text();
    }catch(e){
      host.innerHTML = `
        <div class="module-error">
          <b>Modul konnte nicht geladen werden:</b> ${fragmentPath}<br/>
          ${String(e && e.message ? e.message : e)}
        </div>`;
    }
  }

  /* 1) Erst Modul-HTML-Fragmente laden (sonst rendert JS ins Nichts) */
  await injectFragment("weatherHost", "./home-weather-modul.html");
  await injectFragment("calendarHost", "./home-calendar-modul.html");
  await injectFragment("kpisHost", "./home-kpis-modul.html");

  /* 2) Daten laden (master-data / override) */
  try{
    await DataLoader.load();
  }catch(e){
    console.error("DataLoader.load failed:", e);
  }

  /* 3) Module rendern */
  const wHost = document.getElementById("weatherHost");
  const cHost = document.getElementById("calendarHost");
  const kHost = document.getElementById("kpisHost");

  if (window.HomeWeatherModul?.render) window.HomeWeatherModul.render(wHost);
  if (window.HomeCalendarModul?.render) window.HomeCalendarModul.render(cHost);
  if (window.HomeKpisModul?.render) window.HomeKpisModul.render(kHost);

  /* 4) Race-proof: nochmal kurz nachziehen (iPad Safari Timing) */
  setTimeout(() => {
    if (window.HomeWeatherModul?.render) window.HomeWeatherModul.render(wHost);
    if (window.HomeCalendarModul?.render) window.HomeCalendarModul.render(cHost);
    if (window.HomeKpisModul?.render) window.HomeKpisModul.render(kHost);
  }, 250);

})();
</script>

</body>
</html>
