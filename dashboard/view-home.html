<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dashboard Â· Home</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="theme-color" content="#0b1220" />

  <script>window.__VER="20251220-Home-KPIs-Top-Grid-2";</script>

  <link rel="stylesheet" href="./shell.css?v=20251220-Home-KPIs-Top-Grid-2" />
  <link rel="stylesheet" href="./home-weather-modul.css?v=20251220-Home-KPIs-Top-Grid-2" />
  <link rel="stylesheet" href="./home-calendar-modul.css?v=20251220-Home-KPIs-Top-Grid-2" />
  <link rel="stylesheet" href="./home-kpis-modul.css?v=20251220-Home-KPIs-Top-Grid-2" />

  <style>
    html,body{ overflow-x:hidden; }

    :root{
      --homeGap:14px;

      /* KPI-Bereich: soll auf iPad "above the fold" passen */
      --kpiTopMinH: 760px;     /* falls zu hoch/niedrig: feinjustieren */
      --kpiTopMinHSm: auto;    /* Mobile: auto */
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(15,23,42,.45);
      color:rgba(226,232,240,.82);
      font-size:11px;
      white-space:nowrap;
      max-width:56vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .home-grid{
      display:grid;
      grid-template-columns:repeat(12,minmax(0,1fr));
      gap:var(--homeGap);
      min-width:0;
      align-items:stretch;
    }

    .col-12{ grid-column:span 12; min-width:0; }
    .col-6{ grid-column:span 6; min-width:0; }
    @media (max-width: 900px){
      .col-6{ grid-column:span 12; }
    }

    /* KPI oben: groÃŸ, und KEIN Scroll im Modul (no scroll) */
    .kpi-top{
      min-height: var(--kpiTopMinH);
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    @media (max-width: 900px){
      .kpi-top{ min-height: var(--kpiTopMinHSm); }
    }

    .module-host{
      flex:1 1 auto;
      min-height:0;
      overflow:hidden; /* wichtig: kein horizontal scroll */
    }

    /* KPI Host: kein innerer Scroll */
    #kpisHost{
      overflow:hidden !important;
    }

    /* Wetter/Kalender: gleich hoch, darunter */
    .home-bottom{
      height: 520px;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    @media (max-width: 900px){
      .home-bottom{ height:auto; }
      .module-host{ overflow:visible; }
      #kpisHost{ overflow:visible !important; }
    }

    .module-error{
      font-size:12px;
      color:rgba(226,232,240,.78);
      line-height:1.35;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(239,68,68,.25);
      background:rgba(239,68,68,.08);
    }

    .debugline{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.22);
      color: rgba(226,232,240,.72);
      font-size: 12px;
      line-height:1.35;
      word-break: break-word;
    }

    /* âœ… FORCE: 3 KPIs nebeneinander / 2 untereinander (6 total)
       Wir wrappen nach dem Inject automatisch alles in .kpis-force-grid,
       damit wir NICHT von internen Klassen des Moduls abhÃ¤ngen.
    */
    #kpisHost .kpis-force-grid{
      display:grid !important;
      grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
      gap: 12px !important;
      align-items: stretch !important;
      min-width:0 !important;
    }

    /* Tablet kleiner -> 2 Spalten */
    @media (max-width: 1100px){
      #kpisHost .kpis-force-grid{
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
      }
    }

    /* Mobile -> 1 Spalte */
    @media (max-width: 700px){
      #kpisHost .kpis-force-grid{
        grid-template-columns: 1fr !important;
      }
    }

    /* Falls das KPI-Modul "Cards" als direkte Kinder ausgibt: sauber stretchen */
    #kpisHost .kpis-force-grid > *{
      min-width:0 !important;
    }
  </style>
</head>

<body>
<div class="app">

  <aside class="sidebar">
    <div class="brand">
      <div class="brand-dot"></div>
      <div>
        <div class="brand-title">BÃ¼cking Dashboard</div>
        <div class="brand-sub">Immobilien Â· Projekte Â· KPIs</div>
      </div>
    </div>

    <nav class="nav">
      <a href="./view-home.html" class="active">
        <div class="nav-ic">âŒ‚</div>
        <div class="nav-txt">
          <div class="nav-title">Home</div>
          <div class="nav-sub">Ãœbersicht</div>
        </div>
      </a>

      <div class="nav-label">Vermietung</div>
      <a href="./view-vermietung.html"><div class="nav-ic">ğŸ </div><div class="nav-txt"><div class="nav-title">Vermietung</div><div class="nav-sub">Objekte Â· Anfragen</div></div></a>

      <div class="nav-label">Projekte</div>
      <a href="./view-projects.html"><div class="nav-ic">ğŸ—</div><div class="nav-txt"><div class="nav-title">BaumstraÃŸe</div><div class="nav-sub">Gesamt + Gewerke</div></div></a>
      <a href="./view-project-am-huenenberg.html"><div class="nav-ic">ğŸ—</div><div class="nav-txt"><div class="nav-title">Am HÃ¼nenberg</div><div class="nav-sub">Projekt (Platzhalter)</div></div></a>

      <div class="nav-label">Finanzen</div>
      <a href="./view-finance.html"><div class="nav-ic">â‚¬</div><div class="nav-txt"><div class="nav-title">Finanzen</div><div class="nav-sub">Cashflow, Budget</div></div></a>

      <div class="nav-label">Tools</div>
      <a href="./admin-data.html"><div class="nav-ic">âœ</div><div class="nav-txt"><div class="nav-title">Admin Daten</div><div class="nav-sub">Pflege Master</div></div></a>
    </nav>

    <div class="sidebar-footer">
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </aside>

  <section class="main">
    <header class="topbar">
      <div class="page-title">
        <h1>Home</h1>
        <div>KPIs (oben, 3Ã—2) Â· Wetter & Kalender (unten)</div>
      </div>
      <div class="top-right">
        <span class="chip" id="clockTop">â€”</span>
        <span class="chip" id="dataChip">Daten: â€”</span>
      </div>
    </header>

    <main class="content">
      <div class="container" style="max-width:1400px;">

        <section class="home-grid">

          <section class="card col-12 kpi-top">
            <div class="card-header">
              <div>
                <div class="card-title">KPIs</div>
                <div class="card-sub">home-kpis-modul Â· 6 Monate RÃ¼ckblick Â· 3 Monate Forecast</div>
              </div>
            </div>
            <div class="card-body module-host" id="kpisHost"></div>
          </section>

          <section class="card col-6 home-bottom">
            <div class="card-header"><div><div class="card-title">Wetter</div><div class="card-sub">home-weather-modul</div></div></div>
            <div class="card-body module-host" id="weatherHost"></div>
          </section>

          <section class="card col-6 home-bottom">
            <div class="card-header"><div><div class="card-title">Kalender</div><div class="card-sub">home-calendar-modul</div></div></div>
            <div class="card-body module-host" id="calendarHost"></div>
          </section>

        </section>

        <div class="debugline" id="debugLine">Debug: â€”</div>
      </div>
    </main>
  </section>
</div>

<script src="./data-loader.js?v=20251220-Home-KPIs-Top-Grid-2"></script>

<script src="./home-weather-modul.js?v=20251220-Home-KPIs-Top-Grid-2"></script>
<script src="./home-calendar-modul.js?v=20251220-Home-KPIs-Top-Grid-2"></script>
<script src="./home-kpis-modul.js?v=20251220-Home-KPIs-Top-Grid-2"></script>

<script>
(async function(){

  const clockTop = document.getElementById("clockTop");
  function tick(){
    const d = new Date();
    clockTop.textContent = d.toLocaleString("de-DE",{weekday:"short",hour:"2-digit",minute:"2-digit"});
  }
  tick(); setInterval(tick,15000);

  document.getElementById("logoutBtn").onclick = () => {
    try { localStorage.clear(); } catch {}
    location.href = "./index.html";
  };

  async function injectFragment(hostId, fragmentPath){
    const host = document.getElementById(hostId);
    if (!host) return;

    const url = fragmentPath + "?v=" + encodeURIComponent(window.__VER);
    try{
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error(res.status + " " + res.statusText);
      host.innerHTML = await res.text();
    }catch(e){
      host.innerHTML = `<div class="module-error"><b>Modul konnte nicht geladen werden:</b><br/>${fragmentPath}<br/>${String(e && e.message ? e.message : e)}</div>`;
    }
  }

  // Inject KPI first
  await injectFragment("kpisHost","./home-kpis-modul.html");

  // âœ… FORCE wrap: alles im KPI-Host kommt in ein 3x2 Grid (ohne Modul zu Ã¤ndern)
  (function forceKpiGrid(){
    const host = document.getElementById("kpisHost");
    if(!host) return;

    // falls schon gewrappt -> nix tun
    if(host.querySelector(".kpis-force-grid")) return;

    // alle direkten children sammeln
    const children = Array.from(host.childNodes);
    // wenn nur Text/Whitespace -> lassen
    const hasElement = children.some(n => n.nodeType === 1);
    if(!hasElement) return;

    const wrap = document.createElement("div");
    wrap.className = "kpis-force-grid";

    // verschiebe alle children in wrapper
    children.forEach(n => wrap.appendChild(n));
    host.appendChild(wrap);
  })();

  // Then bottom modules
  await injectFragment("weatherHost","./home-weather-modul.html");
  await injectFragment("calendarHost","./home-calendar-modul.html");

  // Load data
  await DataLoader.load();

  // Chips + debug
  const chip = document.getElementById("dataChip");
  const dbg = document.getElementById("debugLine");
  const meta = window.IMMO_DATA_META || {};
  const homeCount = Array.isArray(window.IMMO_DATA?.home) ? window.IMMO_DATA.home.length : 0;

  if (meta.ok) {
    chip.textContent = `Master:OK Â· Loader:OK Â· Home:${homeCount} Â· v ${meta.version || "â€”"}`;
  } else {
    chip.textContent = `Master:FAIL Â· Loader:OK Â· Home:${homeCount}`;
  }

  dbg.textContent =
    `Debug: expected master url = ${meta.expectedUrl || "(unknown)"} | reason = ${meta.reason || "(none)"} | ` +
    `has IMMO_MASTER_DATA = ${!!window.IMMO_MASTER_DATA} | has IMMO_DATA = ${!!window.IMMO_DATA}`;

  // Render
  const wHost = document.getElementById("weatherHost");
  const cHost = document.getElementById("calendarHost");
  const kHost = document.getElementById("kpisHost");

  if (window.HomeKpisModul?.render) HomeKpisModul.render(kHost);
  if (window.HomeWeatherModul?.render) HomeWeatherModul.render(wHost);
  if (window.HomeCalendarModul?.render) HomeCalendarModul.render(cHost);

  // iPad retry
  setTimeout(() => {

    // wrapper ggf. erneut setzen (falls render DOM neu baut)
    (function forceKpiGrid(){
      const host = document.getElementById("kpisHost");
      if(!host) return;

      // falls render alles ersetzt hat, wrapper neu
      const already = host.querySelector(".kpis-force-grid");
      if(already) return;

      const children = Array.from(host.childNodes);
      const hasElement = children.some(n => n.nodeType === 1);
      if(!hasElement) return;

      const wrap = document.createElement("div");
      wrap.className = "kpis-force-grid";
      children.forEach(n => wrap.appendChild(n));
      host.appendChild(wrap);
    })();

    if (window.HomeKpisModul?.render) HomeKpisModul.render(kHost);
    if (window.HomeWeatherModul?.render) HomeWeatherModul.render(wHost);
    if (window.HomeCalendarModul?.render) HomeCalendarModul.render(cHost);
  }, 250);

})();
</script>

</body>
</html>