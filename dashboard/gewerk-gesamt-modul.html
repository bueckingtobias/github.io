<!-- ===============================
  GEWERK – GESAMTÜBERSICHT MODUL
  Erwartet: window.__PROJECT_ROWS__
  Excel-Struktur:
  - "Aktiv (Ja/Nein)"
  - "Gewerk"
  - "Angebotssumme (€)"
  - "Zahlungen bisher (€)"
  - "Offene Rechnungen (€)"
  - "Baufortschritt (%)"
================================ -->

<div class="gewerk-gesamt-root"></div>

<style>
  .gewerk-gesamt-root{
    border-radius:18px;
    border:1px solid rgba(148,163,184,.35);
    background:
      radial-gradient(circle at top, rgba(148,163,184,.18), rgba(15,23,42,.92));
    position:relative;
    overflow:hidden;
  }

  .gewerk-gesamt-root::before{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(circle at 20% 0%, rgba(59,130,246,.16), transparent 40%),
      radial-gradient(circle at 70% 0%, rgba(34,197,94,.12), transparent 45%),
      radial-gradient(circle at 90% 10%, rgba(249,115,22,.12), transparent 45%);
    pointer-events:none;
  }

  .gg-head{
    padding:16px 16px 12px;
    border-bottom:1px solid rgba(148,163,184,.18);
    display:flex;
    justify-content:space-between;
    gap:12px;
    position:relative;
  }

  .gg-title{
    margin:0;
    font-size:16px;
    font-weight:900;
    color:#e2e8f0;
  }

  .gg-sub{
    margin-top:6px;
    font-size:12px;
    color:rgba(226,232,240,.7);
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }

  .gg-pill{
    font-size:10px;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.45);
    background:rgba(2,6,23,.25);
    white-space:nowrap;
  }

  .gg-status{
    font-size:10px;
    padding:2px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.45);
    background:rgba(2,6,23,.25);
    height:fit-content;
  }

  .gg-status.ok{
    border-color:rgba(34,197,94,.55);
    color:rgba(187,247,208,.95);
  }

  .gg-status.warn{
    border-color:rgba(248,113,113,.65);
    color:rgba(254,202,202,.95);
  }

  .gg-body{
    padding:12px 16px 16px;
    display:grid;
    grid-template-columns:1.15fr .85fr;
    gap:12px;
    position:relative;
  }

  @media (max-width:900px){
    .gg-body{ grid-template-columns:1fr; }
  }

  .gg-panel{
    border-radius:16px;
    border:1px solid rgba(148,163,184,.2);
    background:rgba(15,23,42,.62);
    padding:12px;
  }

  .gg-kpis{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:10px;
    margin-bottom:12px;
  }

  @media (max-width:900px){
    .gg-kpis{ grid-template-columns:repeat(2,1fr); }
  }

  .gg-kpi{
    border-radius:14px;
    border:1px solid rgba(148,163,184,.2);
    background:rgba(15,23,42,.7);
    padding:10px;
  }

  .gg-kpi .l{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.05em;
    color:rgba(226,232,240,.7);
  }

  .gg-kpi .v{
    margin-top:6px;
    font-size:16px;
    font-weight:900;
    color:#e2e8f0;
  }

  .gg-kpi .h{
    margin-top:4px;
    font-size:11px;
    color:rgba(226,232,240,.65);
  }

  .gg-rowtitle{
    display:flex;
    justify-content:space-between;
    margin-bottom:8px;
    font-size:12px;
    font-weight:800;
  }

  .gg-barrow{
    display:grid;
    grid-template-columns:auto 1fr auto;
    gap:8px;
    align-items:center;
    font-size:11px;
    color:rgba(226,232,240,.7);
  }

  .gg-track{
    height:16px;
    border-radius:999px;
    background:rgba(2,6,23,.55);
    border:1px solid rgba(148,163,184,.16);
    overflow:hidden;
    position:relative;
  }

  .gg-fill{
    position:absolute;
    inset:0 auto 0 0;
    width:0%;
    border-radius:999px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:10px;
    font-weight:800;
    color:#fff;
    transition:width .9s cubic-bezier(.16,1,.3,1);
  }

  .orange{ background:linear-gradient(90deg,#f97316,#fb923c); }
  .green{ background:linear-gradient(90deg,#22c55e,#4ade80); }

  .gg-meta{
    margin-top:8px;
    font-size:11px;
    color:rgba(226,232,240,.7);
    line-height:1.3;
  }

  @keyframes warnPulse{
    0%{ box-shadow:0 0 0 0 rgba(248,113,113,.6); }
    60%{ box-shadow:0 0 0 12px rgba(248,113,113,0); }
    100%{ box-shadow:0 0 0 0 rgba(248,113,113,0); }
  }

  .gewerk-gesamt-root.warn{
    border-color:rgba(248,113,113,.65);
    animation:warnPulse 1.6s ease-out infinite;
  }
</style>

<script>
(function(){
  const root = document.currentScript.previousElementSibling;
  if(!root) return;

  const rows = (window.__PROJECT_ROWS__ || [])
    .filter(r => (""+(r["Aktiv (Ja/Nein)"]||"")).toLowerCase().startsWith("j"));

  let offer=0, paid=0, open=0, weightedProg=0;

  rows.forEach(r=>{
    const o = Number(r["Angebotssumme (€)"]||0);
    const p = Number(r["Zahlungen bisher (€)"]||0);
    const pr = Number(r["Baufortschritt (%)"]||0);
    offer += o;
    paid += p;
    open += Number(r["Offene Rechnungen (€)"]||0);
    weightedProg += pr * o;
  });

  const wProg = offer>0 ? weightedProg/offer : 0;
  const payQuote = offer>0 ? paid/offer*100 : 0;
  const rest = offer-paid;

  const eac = wProg>0 ? paid/(wProg/100) : 0;
  const eacDelta = eac-offer;

  const warn = offer>0 && payQuote > (wProg+8);

  root.classList.toggle("warn", warn);

  root.innerHTML = `
    <div class="gg-head">
      <div>
        <h2 class="gg-title">Baumstraße 35 – Gesamtübersicht</h2>
        <div class="gg-sub">
          <span class="gg-pill">Aktive Gewerke: ${rows.length}</span>
          <span class="gg-pill">Offen: ${open.toLocaleString("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:0})}</span>
        </div>
      </div>
      <div class="gg-status ${warn?"warn":"ok"}">
        ${warn?"Risiko: Kosten > Fortschritt":"Status: OK"}
      </div>
    </div>

    <div class="gg-body">
      <div class="gg-panel">
        <div class="gg-kpis">
          <div class="gg-kpi"><div class="l">Gesamtbudget</div><div class="v">${offer.toLocaleString("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:0})}</div></div>
          <div class="gg-kpi"><div class="l">Zahlungen</div><div class="v">${paid.toLocaleString("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:0})}</div><div class="h">${payQuote.toFixed(1)} %</div></div>
          <div class="gg-kpi"><div class="l">Restbudget</div><div class="v">${rest.toLocaleString("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:0})}</div></div>
          <div class="gg-kpi"><div class="l">Fortschritt</div><div class="v">${wProg.toFixed(1)} %</div><div class="h">gewichteter Ø</div></div>
        </div>

        <div class="gg-rowtitle"><span>Kostenquote</span><span>${paid.toLocaleString("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:0})} / ${offer.toLocaleString("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:0})}</span></div>
        <div class="gg-barrow">
          <span>0%</span>
          <div class="gg-track"><div class="gg-fill orange" style="width:${Math.min(payQuote,100)}%">${payQuote.toFixed(1)} %</div></div>
          <span>100%</span>
        </div>

        <div style="height:10px"></div>

        <div class="gg-rowtitle"><span>Fortschritt</span><span>Soll 100%</span></div>
        <div class="gg-barrow">
          <span>0%</span>
          <div class="gg-track"><div class="gg-fill green" style="width:${Math.min(wProg,100)}%">${wProg.toFixed(1)} %</div></div>
          <span>100%</span>
        </div>

        <div class="gg-meta">
          Forecast (EAC): <strong>${eac.toLocaleString("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:0})}</strong>
          · Δ: <strong>${eacDelta.toLocaleString("de-DE",{style:"currency",currency:"EUR",maximumFractionDigits:0})}</strong>
        </div>
      </div>
    </div>
  `;
})();
</script>