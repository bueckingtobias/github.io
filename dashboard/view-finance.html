<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Finanzen ¬∑ Dashboard</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="theme-color" content="#0b1220" />

  <!-- ‚úÖ Version / Cachebuster -->
  <script>window.__VER="20251216-Finance-1";</script>

  <!-- ‚úÖ Shell (Sidebar/Topbar Styles) -->
  <link rel="stylesheet" href="./shell.css?v=20251216-Finance-1" />

  <!-- ‚úÖ Auth -->
  <script src="./auth.js"></script>
  <script>Auth.requireAuth({ loginUrl:"./login.html" });</script>

  <!-- ‚úÖ DataLoader (master-data) -->
  <script src="./data-loader.js?v=20251216-Finance-1"></script>

  <!-- Finance-Module CSS (optional: werden auch per JS geladen; hier bleibt es wie gehabt) -->
  <!-- Wenn du keine doppelten Loads willst, kannst du diese Links entfernen ‚Äì ich lasse sie bewusst weg. -->

  <style>
    /* No horizontal scroll ‚Äì ever */
    html,body{ overflow-x:hidden !important; }
    .main, .content, .container{ min-width:0; }
    .card, .card-body{ min-width:0; }

    .fin-grid{
      display:grid;
      grid-template-columns: repeat(12, minmax(0,1fr));
      gap: var(--gap);
      min-width:0;
      align-items: stretch;
    }
    .span12{ grid-column: span 12; min-width:0; }
    .span6{ grid-column: span 6; min-width:0; }

    @media (max-width: 900px){
      .span6{ grid-column: span 12; }
    }

    /* Equal-height rows (pairs) */
    .row-equal .card{
      height: 100%;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .row-equal .card-body{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      padding: 12px 14px 14px;
    }
    .slot{
      width:100%;
      min-width:0;
      flex:1 1 auto;
      min-height:0;
    }

    /* Budget bigger */
    .budget-big .card-body{
      padding: 16px 16px 18px;
    }

    .alert{
      border-radius:14px;
      border:1px solid rgba(248,113,113,.35);
      background: rgba(248,113,113,.08);
      padding:12px 14px;
      color: rgba(226,232,240,.92);
      font-size:12px;
      line-height:1.35;
      white-space: pre-wrap;
      overflow-wrap:anywhere;
    }
    .alert strong{ font-weight:950; }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.45);
      color: rgba(226,232,240,.82);
      font-size:11px;
      white-space:nowrap;
      max-width:56vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }
  </style>
</head>

<body>
<div class="app">

  <!-- ‚úÖ Sidebar (1:1 wie Home / Projects / Vermietung) -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-dot"></div>
      <div>
        <div class="brand-title">B√ºcking Dashboard</div>
        <div class="brand-sub">Immobilien ¬∑ Projekte ¬∑ KPIs</div>
      </div>
    </div>

    <nav class="nav">
      <a href="./view-home.html">
        <div class="nav-ic">‚åÇ</div>
        <div class="nav-txt">
          <div class="nav-title">Home</div>
          <div class="nav-sub">√úbersicht</div>
        </div>
      </a>

      <div class="nav-label">Vermietung</div>
      <a href="./view-vermietung.html">
        <div class="nav-ic">üè†</div>
        <div class="nav-txt">
          <div class="nav-title">Vermietung</div>
          <div class="nav-sub">Objekte ¬∑ Anfragen</div>
        </div>
      </a>

      <div class="nav-label">Projekte</div>
      <a href="./view-projects.html">
        <div class="nav-ic">üèó</div>
        <div class="nav-txt">
          <div class="nav-title">Baumstra√üe</div>
          <div class="nav-sub">Gesamt + Gewerke</div>
        </div>
      </a>

      <a href="./view-project-am-huenenberg.html">
        <div class="nav-ic">üèó</div>
        <div class="nav-txt">
          <div class="nav-title">Am H√ºnenberg</div>
          <div class="nav-sub">Projekt (Platzhalter)</div>
        </div>
      </a>

      <div class="nav-label">Finanzen</div>
      <a href="./view-finance.html" class="active">
        <div class="nav-ic">‚Ç¨</div>
        <div class="nav-txt">
          <div class="nav-title">Finanzen</div>
          <div class="nav-sub">Cashflow, Budget</div>
        </div>
      </a>

      <div class="nav-label">Tools</div>
      <a href="./admin-data.html">
        <div class="nav-ic">‚úé</div>
        <div class="nav-txt">
          <div class="nav-title">Admin Daten</div>
          <div class="nav-sub">Pflege Master</div>
        </div>
      </a>
    </nav>

    <div class="sidebar-footer">
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </aside>

  <!-- ‚úÖ Main -->
  <section class="main">
    <header class="topbar">
      <div class="page-title">
        <h1>Finanzen</h1>
        <div>Gesamt ¬∑ Cashflow ¬∑ Mieten ¬∑ OP ¬∑ Reserven ¬∑ Budget</div>
      </div>
      <div class="top-right">
        <span class="chip" id="clockTop">‚Äî</span>
        <span class="chip" id="dataChip">Daten: ‚Äî</span>
      </div>
    </header>

    <main class="content">
      <div class="container" style="max-width:1400px;">
        <section class="fin-grid">

          <!-- 1) Gesamt√ºbersicht oben -->
          <section class="span12">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Gesamt√ºbersicht</div>
                  <div class="card-sub">Cashflow, Mieten, OP & Reserven ‚Äì kompakt und Apple-clean.</div>
                </div>
              </div>
              <div class="card-body" style="padding:14px;">
                <div class="slot" id="slotGesamt"></div>
              </div>
            </div>
          </section>

          <!-- 2) Cashflow + Mieten (gleich hoch) -->
          <section class="span6 row-equal">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Cashflow</div>
                  <div class="card-sub">6M R√ºckblick ¬∑ 3M Forecast</div>
                </div>
              </div>
              <div class="card-body">
                <div class="slot" id="slotCashflow"></div>
              </div>
            </div>
          </section>

          <section class="span6 row-equal">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Mieten & Pacht</div>
                  <div class="card-sub">Einnahmen, Auslastung, n√§chste F√§lligkeit</div>
                </div>
              </div>
              <div class="card-body">
                <div class="slot" id="slotMieten"></div>
              </div>
            </div>
          </section>

          <!-- 3) OP + Reserven (gleich hoch wie Reihe 2) -->
          <section class="span6 row-equal">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">OP ‚Äì Offene Posten</div>
                  <div class="card-sub">F√§lligkeiten, √ºberf√§llig, Priorit√§t</div>
                </div>
              </div>
              <div class="card-body">
                <div class="slot" id="slotOP"></div>
              </div>
            </div>
          </section>

          <section class="span6 row-equal">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Reserven</div>
                  <div class="card-sub">Puffer, Runway, Zielkorridor</div>
                </div>
              </div>
              <div class="card-body">
                <div class="slot" id="slotReserven"></div>
              </div>
            </div>
          </section>

          <!-- 4) Budget unten (full width & gr√∂√üer) -->
          <section class="span12 budget-big">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Budget</div>
                  <div class="card-sub">Kategorien, Plan/Ist, Abweichung, Restbudget ‚Äì full width.</div>
                </div>
              </div>
              <div class="card-body">
                <div class="slot" id="slotBudget"></div>
              </div>
            </div>
          </section>

        </section>

        <div class="debugline" id="debugLine" style="
          margin-top:10px;
          padding:10px 12px;
          border-radius:14px;
          border:1px solid rgba(148,163,184,.14);
          background: rgba(2,6,23,.22);
          color: rgba(226,232,240,.72);
          font-size: 12px;
          line-height:1.35;
          word-break: break-word;
        ">Debug: ‚Äî</div>

      </div>
    </main>
  </section>
</div>

<!-- Module scripts (globals m√ºssen exakt so hei√üen) -->
<script src="./finance-gesamt-modul.js?v=20251216-Finance-1"></script>
<script src="./finance-cashflow-modul.js?v=20251216-Finance-1"></script>
<script src="./finance-mieten-modul.js?v=20251216-Finance-1"></script>
<script src="./finance-op-modul.js?v=20251216-Finance-1"></script>
<script src="./finance-reserven-modul.js?v=20251216-Finance-1"></script>
<script src="./finance-budget-modul.js?v=20251216-Finance-1"></script>

<script>
(async function(){

  // Clock
  const clockTop = document.getElementById("clockTop");
  function tick(){
    const d = new Date();
    clockTop.textContent = d.toLocaleString("de-DE",{weekday:"short",hour:"2-digit",minute:"2-digit"});
  }
  tick(); setInterval(tick,15000);

  // Logout
  document.getElementById("logoutBtn").onclick = () => {
    try { localStorage.clear(); } catch {}
    location.href = "./index.html";
  };

  // Cache-bust helper
  const V = new URLSearchParams(location.search).get("v") || String(Date.now());
  const withV = (p)=> p + (p.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(V);

  function showError(el, title, msg){
    el.innerHTML = "";
    const box = document.createElement("div");
    box.className = "alert";
    box.innerHTML = `<strong>${title}</strong>\n${msg}`;
    el.appendChild(box);
  }

  async function loadHtmlInto(url, el){
    const r = await fetch(withV(url), { cache:"no-store" });
    if(!r.ok) throw new Error("HTML nicht geladen (404?): " + url + " (HTTP " + r.status + ")");
    el.innerHTML = await r.text();
  }

  async function mountModule({slotId, html, css, globalName, data}){
    const slot = document.getElementById(slotId);
    try{
      await loadHtmlInto(html, slot);

      // CSS einmal laden (wie Projects/Home Pattern)
      if(css){
        const href = withV(css);
        const exists = document.querySelector('link[data-href="'+css+'"]');
        if(!exists){
          await new Promise((resolve,reject)=>{
            const l=document.createElement("link");
            l.rel="stylesheet"; l.href=href; l.dataset.href=css;
            l.onload=resolve;
            l.onerror=()=>reject(new Error("CSS nicht geladen (404?): " + css));
            document.head.appendChild(l);
          });
        }
      }

      const mod = window[globalName];
      if(!mod) throw new Error("Global fehlt: window." + globalName);
      if(typeof mod.render !== "function") throw new Error("render() fehlt: window." + globalName + ".render");

      mod.render(slot, data);
    }catch(e){
      showError(slot, "Modul konnte nicht geladen werden.", (e && e.message) ? e.message : String(e));
    }
  }

  // ‚úÖ DataLoader laden (MASTER -> IMMO_DATA)
  await DataLoader.load();

  const meta = window.IMMO_DATA_META || {};
  const dbg = document.getElementById("debugLine");
  const chip = document.getElementById("dataChip");

  const hasMaster = !!window.IMMO_MASTER_DATA;
  const hasData = !!window.IMMO_DATA;

  // Finance Daten aus Master-Map (wie in master-data.js)
  const finance = window.IMMO_DATA?.finance || {};
  const financeGesamtRows = Array.isArray(finance.gesamt) ? finance.gesamt : [];
  const financeCashflowRows = Array.isArray(finance.cashflow) ? finance.cashflow : [];
  const financeMietenRows = Array.isArray(finance.mieten) ? finance.mieten : [];
  const financeOPRows = Array.isArray(finance.op) ? finance.op : [];
  const financeReservenRows = Array.isArray(finance.reserven) ? finance.reserven : [];
  const financeBudgetRows = Array.isArray(finance.budget) ? finance.budget : [];

  if (meta.ok && hasMaster){
    chip.textContent = `Master:OK ¬∑ Loader:OK ¬∑ v ${meta.version || "‚Äî"}`;
  } else {
    chip.textContent = `Master:FAIL ¬∑ Loader:OK`;
  }

  dbg.textContent =
    `Debug: expected master url = ${meta.expectedUrl || "(unknown)"} | reason = ${meta.reason || "(none)"} | ` +
    `has IMMO_MASTER_DATA = ${hasMaster} | has IMMO_DATA = ${hasData}`;

  // ‚úÖ Module mounten (Dateinamen bleiben exakt wie vorher)
  await mountModule({
    slotId:"slotGesamt",
    html:"./finance-gesamt-modul.html",
    css:"./finance-gesamt-modul.css",
    globalName:"FinanceGesamtModul",
    data:{ financeGesamtRows, financeCashflowRows, financeMietenRows, financeOPRows, financeReservenRows, financeBudgetRows }
  });

  await mountModule({
    slotId:"slotCashflow",
    html:"./finance-cashflow-modul.html",
    css:"./finance-cashflow-modul.css",
    globalName:"FinanceCashflowModul",
    data:{ financeCashflowRows }
  });

  await mountModule({
    slotId:"slotMieten",
    html:"./finance-mieten-modul.html",
    css:"./finance-mieten-modul.css",
    globalName:"FinanceMietenModul",
    data:{ financeMietenRows }
  });

  await mountModule({
    slotId:"slotOP",
    html:"./finance-op-modul.html",
    css:"./finance-op-modul.css",
    globalName:"FinanceOPModul",
    data:{ financeOPRows }
  });

  await mountModule({
    slotId:"slotReserven",
    html:"./finance-reserven-modul.html",
    css:"./finance-reserven-modul.css",
    globalName:"FinanceReservenModul",
    data:{ financeReservenRows, financeGesamtRows }
  });

  await mountModule({
    slotId:"slotBudget",
    html:"./finance-budget-modul.html",
    css:"./finance-budget-modul.css",
    globalName:"FinanceBudgetModul",
    data:{ financeBudgetRows }
  });

  // iPad retry
  setTimeout(() => {
    try{
      window.FinanceGesamtModul?.render && FinanceGesamtModul.render(document.getElementById("slotGesamt"), { financeGesamtRows, financeCashflowRows, financeMietenRows, financeOPRows, financeReservenRows, financeBudgetRows });
      window.FinanceCashflowModul?.render && FinanceCashflowModul.render(document.getElementById("slotCashflow"), { financeCashflowRows });
      window.FinanceMietenModul?.render && FinanceMietenModul.render(document.getElementById("slotMieten"), { financeMietenRows });
      window.FinanceOPModul?.render && FinanceOPModul.render(document.getElementById("slotOP"), { financeOPRows });
      window.FinanceReservenModul?.render && FinanceReservenModul.render(document.getElementById("slotReserven"), { financeReservenRows, financeGesamtRows });
      window.FinanceBudgetModul?.render && FinanceBudgetModul.render(document.getElementById("slotBudget"), { financeBudgetRows });
    }catch(_){}
  }, 250);

})();
</script>
</body>
</html>