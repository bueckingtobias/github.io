<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Finanzen · Dashboard</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="theme-color" content="#0b1220" />

  <link rel="stylesheet" href="./shell.css" />

  <script src="./auth.js"></script>
  <script>Auth.requireAuth({ loginUrl:"./login.html" });</script>

  <script src="./shell.js"></script>
  <script src="./excel-loader.js"></script>

  <style>
    html,body{ overflow-x:hidden !important; }

    .fin-grid{
      display:grid;
      grid-template-columns: repeat(12, minmax(0,1fr));
      gap: var(--gap);
      min-width:0;
      align-items: stretch;
    }
    .span12{ grid-column: span 12; min-width:0; }
    .span6{ grid-column: span 6; min-width:0; }

    @media (max-width: 900px){
      .span6{ grid-column: span 12; }
    }

    /* ✅ gleiche Höhe innerhalb jeder Doppel-Reihe */
    .row-equal .card{ height:100%; display:flex; flex-direction:column; min-height:0; }
    .row-equal .card-body{ flex:1 1 auto; min-height:0; display:flex; padding: 12px 14px 14px; }
    .row-equal .slot{ flex:1 1 auto; min-height:0; }

    /* Budget darf größer wirken */
    .budget-big .card-body{ padding: 16px 16px 18px; }

    .slot{ width:100%; min-width:0; }

    .alert{
      border-radius:14px;
      border:1px solid rgba(248,113,113,.35);
      background: rgba(248,113,113,.08);
      padding:12px 14px;
      color: rgba(226,232,240,.92);
      font-size:12px;
      line-height:1.35;
      white-space: pre-wrap;
      overflow-wrap:anywhere;
    }
    .alert strong{ font-weight:950; }
  </style>
</head>

<body>
  <div id="app"></div>

  <template id="pageTpl">
    <section class="fin-grid">

      <!-- Gesamtübersicht (oben) -->
      <section class="span12">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Gesamtübersicht</div>
              <div class="card-sub">Cashflow, Mieten, OP & Reserven – kompakt in einer Apple-Style Übersicht.</div>
            </div>
          </div>
          <div class="card-body" style="padding: 14px;">
            <div class="slot" id="slotOverview"></div>
          </div>
        </div>
      </section>

      <!-- Reihe 2: Cashflow + Mieten -->
      <section class="span6 row-equal">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Cashflow</div>
              <div class="card-sub">6M Rückblick · 3M Forecast</div>
            </div>
          </div>
          <div class="card-body">
            <div class="slot" id="slotCashflow"></div>
          </div>
        </div>
      </section>

      <section class="span6 row-equal">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Mieten & Pacht</div>
              <div class="card-sub">Einnahmen, Auslastung, nächste Fälligkeit</div>
            </div>
          </div>
          <div class="card-body">
            <div class="slot" id="slotRents"></div>
          </div>
        </div>
      </section>

      <!-- Reihe 3: OP + Reserven -->
      <section class="span6 row-equal">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">OP – Offene Posten</div>
              <div class="card-sub">Fälligkeiten, überfällig, Prioritäten</div>
            </div>
          </div>
          <div class="card-body">
            <div class="slot" id="slotOP"></div>
          </div>
        </div>
      </section>

      <section class="span6 row-equal">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Reserven & Liquidität</div>
              <div class="card-sub">Reservepuffer, Runway, Zielkorridor</div>
            </div>
          </div>
          <div class="card-body">
            <div class="slot" id="slotReserves"></div>
          </div>
        </div>
      </section>

      <!-- Budget unten (größer, vollbreit) -->
      <section class="span12 budget-big">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Budget & Plan</div>
              <div class="card-sub">Jahresbudget, Kategorien, Abweichungen, Restbudget</div>
            </div>
          </div>
          <div class="card-body">
            <div class="slot" id="slotBudget"></div>
          </div>
        </div>
      </section>

    </section>
  </template>

  <script>
    (async function(){
      Shell.mount({ active:"./view-finance.html", title:"Finanzen", sub:"Übersicht · Cashflow · Mieten · OP · Reserven · Budget" });

      const V = new URLSearchParams(location.search).get("v") || String(Date.now());
      const withV = (p)=> p + (p.includes("?") ? "&" : "?") + "v=" + encodeURIComponent(V);

      function showError(el, title, msg){
        el.innerHTML = "";
        const box = document.createElement("div");
        box.className = "alert";
        box.innerHTML = `<strong>${title}</strong>\n${msg}`;
        el.appendChild(box);
      }

      function loadCssOnce(href){
        const key = withV(href);
        if(document.querySelector('link[data-href="'+href+'"]')) return Promise.resolve();
        return new Promise((resolve,reject)=>{
          const l=document.createElement("link");
          l.rel="stylesheet"; l.href=key; l.dataset.href=href;
          l.onload=resolve;
          l.onerror=()=>reject(new Error("CSS nicht geladen (404?): " + href));
          document.head.appendChild(l);
        });
      }

      function loadJsOnce(src){
        const key = withV(src);
        if(document.querySelector('script[data-src="'+src+'"]')) return Promise.resolve();
        return new Promise((resolve,reject)=>{
          const s=document.createElement("script");
          s.src=key; s.defer=true; s.dataset.src=src;
          s.onload=resolve;
          s.onerror=()=>reject(new Error("JS nicht geladen (404?): " + src));
          document.head.appendChild(s);
        });
      }

      async function loadHtmlInto(url, el){
        const r = await fetch(withV(url), { cache:"no-store" });
        if(!r.ok) throw new Error("HTML nicht geladen (404?): " + url + " (HTTP " + r.status + ")");
        el.innerHTML = await r.text();
      }

      async function mountModule({slotId, html, css, js, globalName, data}){
        const slot = document.getElementById(slotId);
        try{
          await loadHtmlInto(html, slot);
          await loadCssOnce(css);
          await loadJsOnce(js);

          const mod = window[globalName];
          if(!mod) throw new Error("Global fehlt: window." + globalName);
          if(typeof mod.render !== "function") throw new Error("render() fehlt: window." + globalName + ".render");

          mod.render(slot, data);
        }catch(e){
          showError(slot, "Modul konnte nicht geladen werden.", (e && e.message) ? e.message : String(e));
        }
      }

      // Excel laden
      try{
        await ExcelLoader.load(withV("./Dashboard.xlsx"));
      }catch(e){
        console.warn("Excel load failed:", e);
      }

      // Datenbereiche (werden von Dashboard.xlsx gespeist)
      const financeRows   = Array.isArray(window.IMMO_DATA?.finance) ? window.IMMO_DATA.finance : [];
      const opRows        = Array.isArray(window.IMMO_DATA?.op) ? window.IMMO_DATA.op : [];
      const reservesRows  = Array.isArray(window.IMMO_DATA?.reserven) ? window.IMMO_DATA.reserven : [];
      const budgetRows    = Array.isArray(window.IMMO_DATA?.budget) ? window.IMMO_DATA.budget : [];
      const homeKpisRows  = Array.isArray(window.IMMO_DATA?.home) ? window.IMMO_DATA.home : [];

      await mountModule({
        slotId:"slotOverview",
        html:"./finance-overview-modul.html",
        css:"./finance-overview-modul.css",
        js:"./finance-overview-modul.js",
        globalName:"FinanceOverviewModul",
        data:{ financeRows, opRows, reservesRows, budgetRows, homeKpisRows }
      });

      await mountModule({
        slotId:"slotCashflow",
        html:"./finance-cashflow-modul.html",
        css:"./finance-cashflow-modul.css",
        js:"./finance-cashflow-modul.js",
        globalName:"FinanceCashflowModul",
        data:{ financeRows }
      });

      await mountModule({
        slotId:"slotRents",
        html:"./finance-rents-modul.html",
        css:"./finance-rents-modul.css",
        js:"./finance-rents-modul.js",
        globalName:"FinanceRentsModul",
        data:{ financeRows, homeKpisRows }
      });

      await mountModule({
        slotId:"slotOP",
        html:"./finance-op-modul.html",
        css:"./finance-op-modul.css",
        js:"./finance-op-modul.js",
        globalName:"FinanceOPModul",
        data:{ opRows }
      });

      await mountModule({
        slotId:"slotReserves",
        html:"./finance-reserven-modul.html",
        css:"./finance-reserven-modul.css",
        js:"./finance-reserven-modul.js",
        globalName:"FinanceReservenModul",
        data:{ reservesRows, financeRows }
      });

      await mountModule({
        slotId:"slotBudget",
        html:"./finance-budget-modul.html",
        css:"./finance-budget-modul.css",
        js:"./finance-budget-modul.js",
        globalName:"FinanceBudgetModul",
        data:{ budgetRows }
      });

    })();
  </script>
</body>
</html>
