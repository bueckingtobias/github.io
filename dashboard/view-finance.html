<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Finanzen ¬∑ Dashboard</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="theme-color" content="#0b1220" />

  <script>window.__VER="20251220-Finance-Align-1";</script>

  <!-- Shell Styles (wie Home) -->
  <link rel="stylesheet" href="./shell.css?v=20251220-Finance-Align-1" />

  <!-- Module CSS (werden zus√§tzlich dynamisch geladen, aber so ist es direkt stabil) -->
  <link rel="stylesheet" href="./finance-gesamt-modul.css?v=20251220-Finance-Align-1" />
  <link rel="stylesheet" href="./finance-cashflow-modul.css?v=20251220-Finance-Align-1" />
  <link rel="stylesheet" href="./finance-mieten-modul.css?v=20251220-Finance-Align-1" />
  <link rel="stylesheet" href="./finance-op-modul.css?v=20251220-Finance-Align-1" />
  <link rel="stylesheet" href="./finance-reserven-modul.css?v=20251220-Finance-Align-1" />
  <link rel="stylesheet" href="./finance-budget-modul.css?v=20251220-Finance-Align-1" />

  <style>
    html,body{ overflow-x:hidden !important; }

    :root{
      --finGap:14px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.45);
      color: rgba(226,232,240,.82);
      font-size:11px;
      white-space:nowrap;
      max-width:56vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Finance Layout */
    .fin-wrap{
      display:flex;
      flex-direction:column;
      gap: var(--finGap);
      min-width:0;
    }

    .fin-grid{
      display:grid;
      grid-template-columns: repeat(12, minmax(0,1fr));
      gap: var(--finGap);
      min-width:0;
      align-items:stretch;
    }

    .span12{ grid-column: span 12; min-width:0; }
    .span6{ grid-column: span 6; min-width:0; }

    @media (max-width: 900px){
      .span6{ grid-column: span 12; }
    }

    /* Equal height pairs (iPad/desktop) */
    .card.equal{
      height:100%;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .card.equal .card-body{
      flex:1 1 auto;
      min-height:0;
      overflow:hidden;
      display:flex;
      padding: 12px 14px 14px;
    }

    /* Full-width blocks */
    .card.full .card-body{
      padding: 14px;
    }

    /* Budget bigger */
    .card.budget .card-body{
      padding: 16px 16px 18px;
    }

    .module-host{
      width:100%;
      min-width:0;
      flex:1 1 auto;
      min-height:0;
      overflow:hidden;
    }

    .module-error{
      font-size:12px;
      color: rgba(226,232,240,.78);
      line-height:1.35;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
      overflow-wrap:anywhere;
      white-space: pre-wrap;
    }

    /* Kleine Debugline unten optional */
    .debugline{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.22);
      color: rgba(226,232,240,.72);
      font-size: 12px;
      line-height:1.35;
      word-break: break-word;
    }
  </style>

  <!-- Auth -->
  <script src="./auth.js"></script>
  <script>Auth.requireAuth({ loginUrl: "./login.html" });</script>
</head>

<body>
<div class="app">

  <!-- Sidebar (1:1 wie Home) -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-dot"></div>
      <div>
        <div class="brand-title">B√ºcking Dashboard</div>
        <div class="brand-sub">Immobilien ¬∑ Projekte ¬∑ KPIs</div>
      </div>
    </div>

    <nav class="nav">
      <a href="./view-home.html">
        <div class="nav-ic">‚åÇ</div>
        <div class="nav-txt">
          <div class="nav-title">Home</div>
          <div class="nav-sub">√úbersicht</div>
        </div>
      </a>

      <div class="nav-label">Vermietung</div>
      <a href="./view-vermietung.html">
        <div class="nav-ic">üè†</div>
        <div class="nav-txt">
          <div class="nav-title">Vermietung</div>
          <div class="nav-sub">Objekte ¬∑ Anfragen</div>
        </div>
      </a>

      <div class="nav-label">Projekte</div>
      <a href="./view-projects.html">
        <div class="nav-ic">üèó</div>
        <div class="nav-txt">
          <div class="nav-title">Baumstra√üe</div>
          <div class="nav-sub">Gesamt + Gewerke</div>
        </div>
      </a>
      <a href="./view-project-am-huenenberg.html">
        <div class="nav-ic">üèó</div>
        <div class="nav-txt">
          <div class="nav-title">Am H√ºnenberg</div>
          <div class="nav-sub">Projekt (Platzhalter)</div>
        </div>
      </a>

      <div class="nav-label">Finanzen</div>
      <a href="./view-finance.html" class="active">
        <div class="nav-ic">‚Ç¨</div>
        <div class="nav-txt">
          <div class="nav-title">Finanzen</div>
          <div class="nav-sub">Cashflow, Budget</div>
        </div>
      </a>

      <div class="nav-label">Tools</div>
      <a href="./admin-data.html">
        <div class="nav-ic">‚úé</div>
        <div class="nav-txt">
          <div class="nav-title">Admin Daten</div>
          <div class="nav-sub">Pflege Master</div>
        </div>
      </a>
    </nav>

    <div class="sidebar-footer">
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </aside>

  <!-- Main -->
  <section class="main">
    <header class="topbar">
      <div class="page-title">
        <h1>Finanzen</h1>
        <div>Gesamt ¬∑ Cashflow ¬∑ Mieten/Pacht ¬∑ OP ¬∑ Reserven ¬∑ Budget</div>
      </div>
      <div class="top-right">
        <span class="chip" id="clockTop">‚Äî</span>
        <span class="chip" id="dataChip">Daten: ‚Äî</span>
      </div>
    </header>

    <main class="content">
      <div class="container" style="max-width:1400px;">
        <div class="fin-wrap">

          <section class="fin-grid">

            <!-- Gesamt√ºbersicht -->
            <section class="span12">
              <section class="card full">
                <div class="card-header">
                  <div>
                    <div class="card-title">Gesamt√ºbersicht</div>
                    <div class="card-sub">finance-gesamt-modul</div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="module-host" id="hostGesamt"></div>
                </div>
              </section>
            </section>

            <!-- Cashflow + Mieten/Pacht -->
            <section class="span6">
              <section class="card equal">
                <div class="card-header">
                  <div>
                    <div class="card-title">Cashflow</div>
                    <div class="card-sub">finance-cashflow-modul</div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="module-host" id="hostCashflow"></div>
                </div>
              </section>
            </section>

            <section class="span6">
              <section class="card equal">
                <div class="card-header">
                  <div>
                    <div class="card-title">Mieten & Pacht</div>
                    <div class="card-sub">finance-mieten-modul</div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="module-host" id="hostMieten"></div>
                </div>
              </section>
            </section>

            <!-- OP + Reserven -->
            <section class="span6">
              <section class="card equal">
                <div class="card-header">
                  <div>
                    <div class="card-title">OP ‚Äì Offene Posten</div>
                    <div class="card-sub">finance-op-modul</div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="module-host" id="hostOP"></div>
                </div>
              </section>
            </section>

            <section class="span6">
              <section class="card equal">
                <div class="card-header">
                  <div>
                    <div class="card-title">Reserven</div>
                    <div class="card-sub">finance-reserven-modul</div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="module-host" id="hostReserven"></div>
                </div>
              </section>
            </section>

            <!-- Budget -->
            <section class="span12">
              <section class="card budget">
                <div class="card-header">
                  <div>
                    <div class="card-title">Budget</div>
                    <div class="card-sub">finance-budget-modul</div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="module-host" id="hostBudget"></div>
                </div>
              </section>
            </section>

          </section>

          <div class="debugline" id="debugLine">Debug: ‚Äî</div>

        </div>
      </div>
    </main>
  </section>
</div>

<!-- DataLoader (Master) -->
<script src="./data-loader.js?v=20251220-Finance-Align-1"></script>

<!-- Module scripts (render globals) -->
<script src="./finance-gesamt-modul.js?v=20251220-Finance-Align-1"></script>
<script src="./finance-cashflow-modul.js?v=20251220-Finance-Align-1"></script>
<script src="./finance-mieten-modul.js?v=20251220-Finance-Align-1"></script>
<script src="./finance-op-modul.js?v=20251220-Finance-Align-1"></script>
<script src="./finance-reserven-modul.js?v=20251220-Finance-Align-1"></script>
<script src="./finance-budget-modul.js?v=20251220-Finance-Align-1"></script>

<script>
(async function(){

  // Clock
  const clockTop = document.getElementById("clockTop");
  function tick(){
    const d = new Date();
    clockTop.textContent = d.toLocaleString("de-DE",{weekday:"short",hour:"2-digit",minute:"2-digit"});
  }
  tick(); setInterval(tick,15000);

  // Logout
  document.getElementById("logoutBtn").onclick = () => {
    try { localStorage.clear(); } catch {}
    location.href = "./index.html";
  };

  // Inject helper (wie Home)
  async function injectFragment(hostId, fragmentPath){
    const host = document.getElementById(hostId);
    if (!host) return;

    const url = fragmentPath + "?v=" + encodeURIComponent(window.__VER);
    try{
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error(res.status + " " + res.statusText);
      host.innerHTML = await res.text();
    }catch(e){
      host.innerHTML = `<div class="module-error"><b>Modul konnte nicht geladen werden:</b><br/>${fragmentPath}<br/>${String(e && e.message ? e.message : e)}</div>`;
    }
  }

  // 1) Inject all module HTML shells
  await injectFragment("hostGesamt", "./finance-gesamt-modul.html");
  await injectFragment("hostCashflow","./finance-cashflow-modul.html");
  await injectFragment("hostMieten","./finance-mieten-modul.html");
  await injectFragment("hostOP","./finance-op-modul.html");
  await injectFragment("hostReserven","./finance-reserven-modul.html");
  await injectFragment("hostBudget","./finance-budget-modul.html");

  // 2) Load master data
  await DataLoader.load();

  // 3) Data chip + debug
  const meta = window.IMMO_DATA_META || {};
  const hasMaster = !!window.IMMO_MASTER_DATA;
  const f = window.IMMO_DATA && window.IMMO_DATA.finance ? window.IMMO_DATA.finance : {};
  const counts = {
    gesamt: Array.isArray(f.gesamt) ? f.gesamt.length : 0,
    cashflow: Array.isArray(f.cashflow) ? f.cashflow.length : 0,
    mieten: Array.isArray(f.mieten) ? f.mieten.length : 0,
    op: Array.isArray(f.op) ? f.op.length : 0,
    reserven: Array.isArray(f.reserven) ? f.reserven.length : 0,
    budget: Array.isArray(f.budget) ? f.budget.length : 0
  };

  const chip = document.getElementById("dataChip");
  if (meta.ok && hasMaster){
    chip.textContent = `Master:OK ¬∑ Loader:OK ¬∑ Finance: G${counts.gesamt}/C${counts.cashflow}/M${counts.mieten}/OP${counts.op}/R${counts.reserven}/B${counts.budget} ¬∑ v ${meta.version || "‚Äî"}`;
  } else {
    chip.textContent = `Master:FAIL ¬∑ Loader:OK ¬∑ Finance: G${counts.gesamt}/C${counts.cashflow}/M${counts.mieten}/OP${counts.op}/R${counts.reserven}/B${counts.budget} ¬∑ ${meta.reason || ""}`;
  }

  const dbg = document.getElementById("debugLine");
  dbg.textContent =
    `Debug: source=${meta.source || "‚Äî"} | hasMaster=${!!window.IMMO_MASTER_DATA} | hasIMMO_DATA=${!!window.IMMO_DATA} | ` +
    `financeKeys=${Object.keys(f||{}).join(",") || "(none)"}`;

  // 4) Render modules with consistent data mapping (Master ‚Üí Module)
  const homeRows = Array.isArray(window.IMMO_DATA?.home) ? window.IMMO_DATA.home : [];

  const dataGesamt = {
    financeRows: Array.isArray(f.gesamt) ? f.gesamt : [],
    opRows: Array.isArray(f.op) ? f.op : [],
    reservesRows: Array.isArray(f.reserven) ? f.reserven : [],
    budgetRows: Array.isArray(f.budget) ? f.budget : [],
    homeRows
  };

  const dataCashflow = {
    financeRows: Array.isArray(f.cashflow) ? f.cashflow : (Array.isArray(f.gesamt) ? f.gesamt : []),
    homeRows
  };

  const dataMieten = {
    financeRows: Array.isArray(f.mieten) ? f.mieten : (Array.isArray(f.gesamt) ? f.gesamt : []),
    homeRows
  };

  const dataOP = { opRows: Array.isArray(f.op) ? f.op : [] };
  const dataRes = { reservesRows: Array.isArray(f.reserven) ? f.reserven : [], financeRows: Array.isArray(f.gesamt) ? f.gesamt : [] };
  const dataBudget = { budgetRows: Array.isArray(f.budget) ? f.budget : [] };

  const hGesamt   = document.getElementById("hostGesamt");
  const hCashflow = document.getElementById("hostCashflow");
  const hMieten   = document.getElementById("hostMieten");
  const hOP       = document.getElementById("hostOP");
  const hRes      = document.getElementById("hostReserven");
  const hBudget   = document.getElementById("hostBudget");

  function safeRender(globalName, host, data){
    const mod = window[globalName];
    if (!host) return;
    if (!mod || typeof mod.render !== "function"){
      host.innerHTML = `<div class="module-error"><b>Modul fehlt:</b> window.${globalName}.render</div>`;
      return;
    }
    try{
      mod.render(host, data || {});
    }catch(e){
      host.innerHTML = `<div class="module-error"><b>Render-Fehler:</b> window.${globalName}.render<br/>${String(e && e.message ? e.message : e)}</div>`;
    }
  }

  safeRender("FinanceGesamtModul", hGesamt, dataGesamt);
  safeRender("FinanceCashflowModul", hCashflow, dataCashflow);
  safeRender("FinanceMietenModul", hMieten, dataMieten);
  safeRender("FinanceOPModul", hOP, dataOP);
  safeRender("FinanceReservenModul", hRes, dataRes);
  safeRender("FinanceBudgetModul", hBudget, dataBudget);

  // iPad Safari retry (wie Home)
  setTimeout(() => {
    safeRender("FinanceGesamtModul", hGesamt, dataGesamt);
    safeRender("FinanceCashflowModul", hCashflow, dataCashflow);
    safeRender("FinanceMietenModul", hMieten, dataMieten);
    safeRender("FinanceOPModul", hOP, dataOP);
    safeRender("FinanceReservenModul", hRes, dataRes);
    safeRender("FinanceBudgetModul", hBudget, dataBudget);
  }, 250);

})();
</script>

</body>
</html>