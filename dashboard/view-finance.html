<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Finanzen ¬∑ Dashboard</title>
  <meta name="robots" content="noindex,nofollow" />
  <meta name="theme-color" content="#0b1220" />

  <!-- Version / Cache bust (einheitlich) -->
  <script>window.__VER="20251220-Finance-1";</script>

  <!-- Shell (Basis-Design, Buttons, Sidebar, Cards) -->
  <link rel="stylesheet" href="./shell.css?v=20251220-Finance-1" />

  <!-- Module CSS (WICHTIG: direkt im Head laden, nicht dynamisch) -->
  <link rel="stylesheet" href="./finance-gesamt-modul.css?v=20251220-Finance-1" />
  <link rel="stylesheet" href="./finance-cashflow-modul.css?v=20251220-Finance-1" />
  <link rel="stylesheet" href="./finance-mieten-modul.css?v=20251220-Finance-1" />
  <link rel="stylesheet" href="./finance-op-modul.css?v=20251220-Finance-1" />
  <link rel="stylesheet" href="./finance-reserven-modul.css?v=20251220-Finance-1" />
  <link rel="stylesheet" href="./finance-budget-modul.css?v=20251220-Finance-1" />

  <style>
    /* No horizontal scroll ‚Äì ever */
    html,body{ overflow-x:hidden !important; }

    .fin-grid{
      display:grid;
      grid-template-columns: repeat(12, minmax(0,1fr));
      gap: 14px;
      min-width:0;
      align-items: stretch;
    }
    .span12{ grid-column: span 12; min-width:0; }
    .span6{ grid-column: span 6; min-width:0; }
    @media (max-width: 900px){
      .span6{ grid-column: span 12; }
    }

    /* Equal-height rows (pairs) */
    .row-equal .card{
      height: 100%;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .row-equal .card-body{
      flex:1 1 auto;
      min-height:0;
      padding: 12px 14px 14px;
      overflow:hidden; /* verhindert seitlichen overflow im Modul */
    }

    .slot{
      width:100%;
      min-width:0;
    }

    .budget-big .card-body{
      padding: 16px 16px 18px;
    }

    .module-host{
      min-width:0;
      overflow:hidden;
    }

    .module-error{
      font-size:12px;
      color: rgba(226,232,240,.78);
      line-height:1.35;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
      white-space: pre-wrap;
      overflow-wrap:anywhere;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.45);
      color: rgba(226,232,240,.82);
      font-size:11px;
      white-space:nowrap;
      max-width:56vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }
  </style>

  <!-- Auth -->
  <script src="./auth.js?v=20251220-Finance-1"></script>
  <script>Auth.requireAuth({ loginUrl:"./login.html" });</script>
</head>

<body>
<div class="app">

  <!-- Sidebar 1:1 wie Home (mit Logout Button) -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-dot"></div>
      <div>
        <div class="brand-title">B√ºcking Dashboard</div>
        <div class="brand-sub">Immobilien ¬∑ Projekte ¬∑ KPIs</div>
      </div>
    </div>

    <nav class="nav">
      <a href="./view-home.html">
        <div class="nav-ic">‚åÇ</div>
        <div class="nav-txt">
          <div class="nav-title">Home</div>
          <div class="nav-sub">√úbersicht</div>
        </div>
      </a>

      <div class="nav-label">Vermietung</div>
      <a href="./view-vermietung.html">
        <div class="nav-ic">üè†</div>
        <div class="nav-txt">
          <div class="nav-title">Vermietung</div>
          <div class="nav-sub">Objekte ¬∑ Anfragen</div>
        </div>
      </a>

      <div class="nav-label">Projekte</div>
      <a href="./view-projects.html">
        <div class="nav-ic">üèó</div>
        <div class="nav-txt">
          <div class="nav-title">Baumstra√üe</div>
          <div class="nav-sub">Gesamt + Gewerke</div>
        </div>
      </a>
      <a href="./view-project-am-huenenberg.html">
        <div class="nav-ic">üèó</div>
        <div class="nav-txt">
          <div class="nav-title">Am H√ºnenberg</div>
          <div class="nav-sub">Projekt (Platzhalter)</div>
        </div>
      </a>

      <div class="nav-label">Finanzen</div>
      <a href="./view-finance.html" class="active">
        <div class="nav-ic">‚Ç¨</div>
        <div class="nav-txt">
          <div class="nav-title">Finanzen</div>
          <div class="nav-sub">Cashflow, Budget</div>
        </div>
      </a>

      <div class="nav-label">Tools</div>
      <a href="./admin-data.html">
        <div class="nav-ic">‚úé</div>
        <div class="nav-txt">
          <div class="nav-title">Admin Daten</div>
          <div class="nav-sub">Pflege Master</div>
        </div>
      </a>
    </nav>

    <div class="sidebar-footer">
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </aside>

  <!-- Main -->
  <section class="main">
    <header class="topbar">
      <div class="page-title">
        <h1>Finanzen</h1>
        <div>Gesamt ¬∑ Cashflow ¬∑ Mieten ¬∑ Reserven ¬∑ Budget</div>
      </div>
      <div class="top-right">
        <span class="chip" id="clockTop">‚Äî</span>
        <span class="chip" id="dataChip">Daten: ‚Äî</span>
      </div>
    </header>

    <main class="content">
      <div class="container" style="max-width:1400px;">
        <section class="fin-grid">

          <!-- 1) Gesamt√ºbersicht -->
          <section class="span12">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Gesamt√ºbersicht</div>
                  <div class="card-sub">finance-gesamt-modul</div>
                </div>
              </div>
              <div class="card-body module-host">
                <div class="slot" id="slotGesamt"></div>
              </div>
            </div>
          </section>

          <!-- 2) Cashflow + Mieten -->
          <section class="span6 row-equal">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Cashflow</div>
                  <div class="card-sub">finance-cashflow-modul</div>
                </div>
              </div>
              <div class="card-body module-host">
                <div class="slot" id="slotCashflow"></div>
              </div>
            </div>
          </section>

          <section class="span6 row-equal">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Mieten & Pacht</div>
                  <div class="card-sub">finance-mieten-modul</div>
                </div>
              </div>
              <div class="card-body module-host">
                <div class="slot" id="slotMieten"></div>
              </div>
            </div>
          </section>

          <!-- 3) OP + Reserven -->
          <section class="span6 row-equal">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">OP ‚Äì Offene Posten</div>
                  <div class="card-sub">finance-op-modul</div>
                </div>
              </div>
              <div class="card-body module-host">
                <div class="slot" id="slotOP"></div>
              </div>
            </div>
          </section>

          <section class="span6 row-equal">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Reserven</div>
                  <div class="card-sub">finance-reserven-modul</div>
                </div>
              </div>
              <div class="card-body module-host">
                <div class="slot" id="slotReserven"></div>
              </div>
            </div>
          </section>

          <!-- 4) Budget -->
          <section class="span12 budget-big">
            <div class="card">
              <div class="card-header">
                <div>
                  <div class="card-title">Budget</div>
                  <div class="card-sub">finance-budget-modul</div>
                </div>
              </div>
              <div class="card-body module-host">
                <div class="slot" id="slotBudget"></div>
              </div>
            </div>
          </section>

        </section>
      </div>
    </main>
  </section>
</div>

<!-- DataLoader (Master) -->
<script src="./data-loader.js?v=20251220-Finance-1"></script>

<!-- Module JS (WICHTIG: direkt laden, nicht dynamisch) -->
<script src="./finance-gesamt-modul.js?v=20251220-Finance-1"></script>
<script src="./finance-cashflow-modul.js?v=20251220-Finance-1"></script>
<script src="./finance-mieten-modul.js?v=20251220-Finance-1"></script>
<script src="./finance-op-modul.js?v=20251220-Finance-1"></script>
<script src="./finance-reserven-modul.js?v=20251220-Finance-1"></script>
<script src="./finance-budget-modul.js?v=20251220-Finance-1"></script>

<script>
(async function(){

  // Clock
  const clockTop = document.getElementById("clockTop");
  function tick(){
    const d = new Date();
    clockTop.textContent = d.toLocaleString("de-DE",{weekday:"short",hour:"2-digit",minute:"2-digit"});
  }
  tick(); setInterval(tick,15000);

  // Logout
  document.getElementById("logoutBtn").onclick = () => {
    try { localStorage.clear(); } catch {}
    location.href = "./index.html";
  };

  // Inject helper
  async function inject(slotId, fragmentPath){
    const slot = document.getElementById(slotId);
    if(!slot) return;

    const url = fragmentPath + "?v=" + encodeURIComponent(window.__VER);
    try{
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error(res.status + " " + res.statusText);
      slot.innerHTML = await res.text();
    }catch(e){
      slot.innerHTML =
        `<div class="module-error"><b>Modul konnte nicht geladen werden:</b>\n${fragmentPath}\n${String(e && e.message ? e.message : e)}</div>`;
    }
  }

  // 1) Inject module HTML
  await inject("slotGesamt","./finance-gesamt-modul.html");
  await inject("slotCashflow","./finance-cashflow-modul.html");
  await inject("slotMieten","./finance-mieten-modul.html");
  await inject("slotOP","./finance-op-modul.html");
  await inject("slotReserven","./finance-reserven-modul.html");
  await inject("slotBudget","./finance-budget-modul.html");

  // 2) Load data (Master -> IMMO_DATA)
  await DataLoader.load();

  // 3) Chip
  const chip = document.getElementById("dataChip");
  const meta = window.IMMO_DATA_META || {};
  const hasMaster = !!window.IMMO_MASTER_DATA;

  const fin = window.IMMO_DATA?.finance || {};
  const counts = [
    Array.isArray(fin.gesamt) ? fin.gesamt.length : 0,
    Array.isArray(fin.cashflow) ? fin.cashflow.length : 0,
    Array.isArray(fin.mieten) ? fin.mieten.length : 0,
    Array.isArray(fin.op) ? fin.op.length : 0,
    Array.isArray(fin.reserven) ? fin.reserven.length : 0,
    Array.isArray(fin.budget) ? fin.budget.length : 0
  ];

  if(meta.ok && hasMaster){
    chip.textContent = `Master:OK ¬∑ Loader:OK ¬∑ Finance:${counts.join("/") } ¬∑ v ${meta.version || "‚Äî"}`;
  } else {
    chip.textContent = `Master:FAIL ¬∑ Loader:OK ¬∑ Finance:${counts.join("/") } ¬∑ ${meta.reason || ""}`;
  }

  // 4) Render modules
  const slotGesamt = document.getElementById("slotGesamt");
  const slotCashflow = document.getElementById("slotCashflow");
  const slotMieten = document.getElementById("slotMieten");
  const slotOP = document.getElementById("slotOP");
  const slotReserven = document.getElementById("slotReserven");
  const slotBudget = document.getElementById("slotBudget");

  // Data packages (falls Module data erwarten)
  const pkgGesamt = {
    finance: fin,
    financeRows: fin.gesamt || [],
    opRows: fin.op || [],
    reservesRows: fin.reserven || [],
    budgetRows: fin.budget || [],
    homeRows: Array.isArray(window.IMMO_DATA?.home) ? window.IMMO_DATA.home : []
  };

  if(window.FinanceGesamtModul?.render) window.FinanceGesamtModul.render(slotGesamt, pkgGesamt);
  if(window.FinanceCashflowModul?.render) window.FinanceCashflowModul.render(slotCashflow, { finance: fin, financeRows: fin.cashflow || [] });
  if(window.FinanceMietenModul?.render) window.FinanceMietenModul.render(slotMieten, { finance: fin, homeRows: pkgGesamt.homeRows, financeRows: fin.mieten || [] });
  if(window.FinanceOPModul?.render) window.FinanceOPModul.render(slotOP, { opRows: fin.op || [] });
  if(window.FinanceReservenModul?.render) window.FinanceReservenModul.render(slotReserven, { reservesRows: fin.reserven || [], financeRows: fin.gesamt || [] });
  if(window.FinanceBudgetModul?.render) window.FinanceBudgetModul.render(slotBudget, { budgetRows: fin.budget || [] });

  // iPad retry
  setTimeout(() => {
    if(window.FinanceGesamtModul?.render) window.FinanceGesamtModul.render(slotGesamt, pkgGesamt);
    if(window.FinanceCashflowModul?.render) window.FinanceCashflowModul.render(slotCashflow, { finance: fin, financeRows: fin.cashflow || [] });
    if(window.FinanceMietenModul?.render) window.FinanceMietenModul.render(slotMieten, { finance: fin, homeRows: pkgGesamt.homeRows, financeRows: fin.mieten || [] });
    if(window.FinanceOPModul?.render) window.FinanceOPModul.render(slotOP, { opRows: fin.op || [] });
    if(window.FinanceReservenModul?.render) window.FinanceReservenModul.render(slotReserven, { reservesRows: fin.reserven || [], financeRows: fin.gesamt || [] });
    if(window.FinanceBudgetModul?.render) window.FinanceBudgetModul.render(slotBudget, { budgetRows: fin.budget || [] });
  }, 250);

})();
</script>

</body>
</html>