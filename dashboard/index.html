<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B√ºcking Immobilien ‚Äì Dashboard</title>
  <meta name="robots" content="noindex, nofollow">

  <style>
    :root {
      --bg-page: radial-gradient(circle at top left, #181b29 0, #05060a 60%);
      --bg: #05060a;
      --bg-elevated: #11131c;
      --accent: #0ea568;
      --accent-2: #1d8bff;
      --accent-3: #ffb020;
      --accent-4: #b15cff;
      --accent-soft: rgba(14,165,104,0.16);
      --text: #f5f5f7;
      --text-soft: #a3a6b7;
      --border: #262938;
      --radius: 14px;
    }

    :root[data-theme="light"] {
      --bg-page: #f4f5f7;
      --bg: #f4f5f7;
      --bg-elevated: #ffffff;
      --accent: #0ea568;
      --accent-2: #2563eb;
      --accent-3: #f59e0b;
      --accent-4: #8b5cf6;
      --accent-soft: rgba(14,165,104,0.12);
      --text: #111827;
      --text-soft: #6b7280;
      --border: #d1d5db;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      min-height: 100dvh;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      background: var(--bg-page);
      color: var(--text);
    }

    body {
      display: flex;
      align-items: stretch;
      justify-content: stretch;
      overflow: hidden; /* nur internes Scrollen in den Views */
    }

    /* LOGIN */

    #login-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #151724 0, #02030a 60%);
      z-index: 20;
    }
    :root[data-theme="light"] #login-overlay {
      background: rgba(15,23,42,0.12);
    }

    .login-card {
      width: 100%;
      max-width: 380px;
      background: linear-gradient(145deg, #10121c, #171927);
      padding: 26px 24px 20px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
    }
    :root[data-theme="light"] .login-card {
      background: #ffffff;
      border-color: #e5e7eb;
      box-shadow: 0 18px 40px rgba(15,23,42,0.15);
      color: #111827;
    }

    .login-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 18px;
    }
    .logo-mark {
      width: 26px;
      height: 26px;
      border-radius: 9px;
      background: radial-gradient(circle at 30% 0, #2ad18b, #004225);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: #ffffff;
    }
    .login-title { font-size: 17px; font-weight: 600; }
    .login-subtitle { font-size: 12px; color: var(--text-soft); margin-top: 2px; }

    .login-label {
      font-size: 13px;
      margin-bottom: 6px;
      margin-top: 10px;
      display: block;
    }
    .login-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(4,4,10,0.9);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }
    :root[data-theme="light"] .login-input {
      background: #f9fafb;
    }
    .login-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(14,165,104,0.5);
    }

    .login-actions { margin-top: 16px; }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 9px 16px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }
    .btn-primary {
      width: 100%;
      background: linear-gradient(135deg, #1f7f4b, #004225);
      color: #fff;
      box-shadow: 0 10px 18px rgba(0,0,0,0.5);
    }
    :root[data-theme="light"] .btn-primary {
      background: linear-gradient(135deg, #0ea568, #15803d);
      box-shadow: 0 8px 16px rgba(15,118,110,0.35);
    }
    .btn-primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }

    .login-error {
      margin-top: 10px;
      font-size: 12px;
      color: #ff4b5c;
      min-height: 18px;
    }
    .login-meta {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      opacity: 0.75;
    }

    /* SHELL */

    #app {
      display: none;
      width: 100%;
      min-height: 100dvh;
    }

    .shell {
      display: grid;
      grid-template-columns: 220px 1fr;
      height: 100dvh;
      max-height: 100dvh;
    }

    aside {
      background: radial-gradient(circle at top, #181a27 0, #05060b 60%);
      border-right: 1px solid rgba(255,255,255,0.06);
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    :root[data-theme="light"] aside {
      background: #111827;
      border-right-color: #1f2937;
      color: #f9fafb;
    }

    .sidebar-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
      margin-bottom: 4px;
    }
    .nav-section-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
      margin: 4px 3px;
    }
    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      border-radius: 999px;
      border: none;
      padding: 7px 10px;
      background: transparent;
      color: var(--text-soft);
      font-size: 13px;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background .15s ease, transform .1s ease;
    }
    .nav-item span.icon { width: 18px; text-align: center; }
    .nav-item:hover { background: rgba(255,255,255,0.06); transform: translateY(-1px); }
    .nav-item.active {
      background: var(--accent-soft);
      color: #fff;
      box-shadow: 0 10px 20px rgba(0,0,0,0.6);
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 11px;
      color: var(--text-soft);
      border-top: 1px solid rgba(255,255,255,0.12);
      padding-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .logout-btn {
      align-self: flex-start;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(248,113,113,0.7);
      background: rgba(248,113,113,0.08);
      color: #fecaca;
      font-size: 11px;
      cursor: pointer;
    }
    :root[data-theme="light"] .logout-btn {
      color: #b91c1c;
      background: #fee2e2;
      border-color: #fecaca;
    }

    .main {
      padding: 10px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
      background: transparent;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .topbar-title { font-size: 18px; font-weight: 600; }
    .topbar-sub { font-size: 12px; color: var(--text-soft); }

    .pill-row {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 11px;
      color: var(--text-soft);
      white-space: nowrap;
      background: rgba(0,0,0,0.08);
    }
    :root[data-theme="light"] .pill {
      background: #ffffff;
      border-color: #e5e7eb;
    }
    .pill-accent {
      border-color: rgba(14,165,104,0.7);
      background: var(--accent-soft);
      color: #eafff6;
    }
    :root[data-theme="light"] .pill-accent { color: #065f46; }
    .pill-theme { cursor: pointer; }

    /* Container f√ºr Views */
    #view-container {
      flex: 1;
      min-height: 0;
      overflow: hidden; /* jede View scrollt in sich */
    }

    .view-root {
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
    }

    .card {
      background: linear-gradient(145deg, var(--bg-elevated), #090a12);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 10px 12px 10px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.6);
    }
    :root[data-theme="light"] .card {
      background: #ffffff;
      border-color: #e5e7eb;
      box-shadow: 0 10px 25px rgba(15,23,42,0.08);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }
    .card-title { font-size: 14px; font-weight: 500; margin-bottom: 2px; }
    .card-sub { font-size: 12px; color: var(--text-soft); }

    .tag {
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.07);
      font-size: 11px;
      color: var(--text-soft);
      white-space: nowrap;
    }
    :root[data-theme="light"] .tag {
      background: #f3f4f6;
      color: #4b5563;
    }

    .summary-block {
      font-size: 12px;
      color: var(--text-soft);
      margin-top: 2px;
      line-height: 1.5;
    }

    /* Tabellen / Badges */
    .table-wrapper {
      max-height: 200px;
      overflow: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    thead {
      position: sticky;
      top: 0;
      background: var(--bg-elevated);
      z-index: 1;
    }
    th, td {
      padding: 4px 6px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    tbody tr:hover {
      background: rgba(255,255,255,0.03);
    }
    :root[data-theme="light"] tbody tr:hover {
      background: #f3f4f6;
    }

    .badge-status {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid transparent;
    }
    .badge-status.ok {
      background: rgba(34,197,94,0.15);
      color: #bbf7d0;
      border-color: rgba(34,197,94,0.6);
    }
    .badge-status.leer {
      background: rgba(148,163,184,0.15);
      color: #e5e7eb;
      border-color: rgba(148,163,184,0.6);
    }
    .badge-status.risky {
      background: rgba(248,113,113,0.18);
      color: #fecaca;
      border-color: rgba(248,113,113,0.7);
    }
    :root[data-theme="light"] .badge-status.ok {
      background: #dcfce7;
      color: #166534;
      border-color: #16a34a;
    }
    :root[data-theme="light"] .badge-status.leer {
      background: #e5e7eb;
      color: #374151;
      border-color: #9ca3af;
    }
    :root[data-theme="light"] .badge-status.risky {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #f97373;
    }

    .chart-container {
      position: relative;
      width: 100%;
      height: 100%;
      min-height: 140px;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }
    @media (max-width: 900px) {
      .kpi-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .kpi-card {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background: radial-gradient(circle at top, rgba(255,255,255,0.05), rgba(0,0,0,0.9));
    }
    :root[data-theme="light"] .kpi-card {
      background: linear-gradient(135deg, #ffffff, #f9fafb);
      border-color: #e5e7eb;
    }
    .kpi-label {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 2px;
    }
    .kpi-value {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .kpi-subline {
      font-size: 11px;
      color: var(--text-soft);
    }

    select#object-select {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.25);
      color: var(--text);
    }
    :root[data-theme="light"] select#object-select {
      background: #ffffff;
      border-color: #d1d5db;
      color: #111827;
    }

    .chart-title {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    @media (max-width: 900px) {
      .shell {
        grid-template-columns: 70px 1fr;
      }
      .sidebar-title,
      .nav-section-label,
      .sidebar-footer {
        display: none;
      }
      .nav-item span.label { display: none; }
      .nav-item {
        justify-content: center;
        padding-inline: 0;
      }
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="login-overlay">
    <div class="login-card">
      <div class="login-logo">
        <div class="logo-mark">BI</div>
        <div>
          <div class="login-title">B√ºcking Immobilien Dashboard</div>
          <div class="login-subtitle">Gesch√ºtzter Zugang ‚Äì interne √úbersicht.</div>
        </div>
      </div>

      <label class="login-label" for="login-password">Passwort</label>
      <input type="password" id="login-password" class="login-input" autocomplete="current-password" />

      <div class="login-actions">
        <button class="btn btn-primary" id="login-button">Login</button>
      </div>

      <div class="login-error" id="login-error"></div>
      <div class="login-meta">
        <span>Dashboard v0.7 (Home vollfl√§chig)</span>
        <span id="login-date"></span>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app">
    <div class="shell">
      <aside>
        <div class="sidebar-title">Dashboard</div>

        <div class="nav-section-label">Start</div>
        <div class="nav-list">
          <button class="nav-item active" data-view="home">
            <span class="icon">üè†</span><span class="label">Dashboard</span>
          </button>
        </div>

        <div class="nav-section-label">√úbersicht</div>
        <div class="nav-list">
          <button class="nav-item" data-view="portfolio">
            <span class="icon">üìä</span><span class="label">Portfolio</span>
          </button>
          <button class="nav-item" data-view="objects">
            <span class="icon">üè¢</span><span class="label">Objekte</span>
          </button>
          <button class="nav-item" data-view="projects">
            <span class="icon">üõ†Ô∏è</span><span class="label">Projekte/Bau</span>
          </button>
        </div>

        <div class="nav-section-label">Finanzen</div>
        <div class="nav-list">
          <button class="nav-item" data-view="finance">
            <span class="icon">üí∂</span><span class="label">Finanzen</span>
          </button>
          <button class="nav-item" data-view="reports">
            <span class="icon">üìë</span><span class="label">Reports</span>
          </button>
        </div>

        <div class="nav-section-label">System</div>
        <div class="nav-list">
          <button class="nav-item" data-view="settings">
            <span class="icon">‚öôÔ∏è</span><span class="label">Einstellungen</span>
          </button>
        </div>

        <div class="sidebar-footer">
          <button class="logout-btn" id="logout-btn">Logout</button>
          <div>Angemeldet als: Gesch√§ftsf√ºhrung</div>
          <div style="font-size:10px;">Daten & Prognosen: Dummy-Basis.</div>
        </div>
      </aside>

      <main class="main">
        <div class="topbar">
          <div>
            <div class="topbar-title" id="topbar-title">Dashboard</div>
            <div class="topbar-sub" id="topbar-sub">√úbersicht: Wetter, Kalender & Branchen-News.</div>
          </div>
          <div class="pill-row">
            <span class="pill" id="topbar-date"></span>
            <span class="pill pill-accent">B√ºcking Immobilien</span>
            <span class="pill pill-theme" id="theme-pill">Modus: Dunkel</span>
          </div>
        </div>

        <div id="view-container">
          <!-- Views werden hier per fetch geladen -->
        </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const PASSWORD = "BI_Dashboard_2025";

    // Dummy Portfolio Daten
    const DATA = {
      objects: [
        {
          id: "hof-ganderkesee",
          name: "Hof Ganderkesee",
          city: "Ganderkesee",
          totalArea: 1150,
          monthlyRentActual: 32400,
          monthlyRentPotential: 33800,
          vacancyUnits: 1,
          vacancyArea: 65,
          roi: 8.4,
          equity: 1250000,
          cashflowYear: 105000,
          units: [
            { name: "Whg 1 | EG links", floor: "EG", area: 78, status: "vermietet", tenant: "M. Beispiel", rent: 980, nk: 240, paymentStatus: "p√ºnktlich" },
            { name: "Whg 2 | EG rechts", floor: "EG", area: 82, status: "leer", tenant: "", rent: 1050, nk: 260, paymentStatus: "" },
            { name: "Whg 3 | OG links", floor: "OG", area: 94, status: "vermietet", tenant: "F. Mieter", rent: 1280, nk: 290, paymentStatus: "R√ºckstand" }
          ],
          projects: [
            { id: "p-ausbau-scheune", name: "Ausbau Scheune", status: "laufend", budget: 1100000, spent: 630000, deviationPercent: 2 }
          ]
        },
        {
          id: "neubau-syke",
          name: "Neubau Syke",
          city: "Syke",
          totalArea: 840,
          monthlyRentActual: 18200,
          monthlyRentPotential: 20500,
          vacancyUnits: 2,
          vacancyArea: 90,
          roi: 7.1,
          equity: 950000,
          cashflowYear: 68000,
          units: [
            { name: "Whg 1 | Haus A", floor: "EG", area: 70, status: "vermietet", tenant: "A. Mustermann", rent: 1100, nk: 230, paymentStatus: "p√ºnktlich" },
            { name: "Whg 2 | Haus A", floor: "OG", area: 75, status: "leer", tenant: "", rent: 1200, nk: 240, paymentStatus: "" }
          ],
          projects: [
            { id: "p-neubau-haus-b", name: "Neubau Haus B", status: "kritisch", budget: 2400000, spent: 1280000, deviationPercent: 8 }
          ]
        },
        {
          id: "stadtvilla-bremen",
          name: "Stadtvilla Bremen",
          city: "Bremen",
          totalArea: 520,
          monthlyRentActual: 11600,
          monthlyRentPotential: 11600,
          vacancyUnits: 0,
          vacancyArea: 0,
          roi: 6.3,
          equity: 600000,
          cashflowYear: 38000,
          units: [
            { name: "Whg 1 | 1. OG", floor: "1. OG", area: 120, status: "vermietet", tenant: "Familie Hanse", rent: 1950, nk: 320, paymentStatus: "p√ºnktlich" }
          ],
          projects: [
            { id: "p-fassade-dach", name: "Fassade & Dach", status: "abgeschlossen", budget: 280000, spent: 280000, deviationPercent: 0 }
          ]
        }
      ]
    };

    function formatEuro(v){ return v.toLocaleString("de-DE",{minimumFractionDigits:0})+" ‚Ç¨"; }
    function formatPercent(v){ return v.toLocaleString("de-DE",{maximumFractionDigits:1})+" %"; }
    function formatArea(v){ return v.toLocaleString("de-DE",{maximumFractionDigits:0})+" m¬≤"; }
    function formatDeviation(p){ const s=p>0?"+":""; return s+p.toLocaleString("de-DE",{maximumFractionDigits:1})+" %"; }

    // Theme
    function applyTheme(theme){
      const root=document.documentElement;
      if(theme!=="light" && theme!=="dark") theme="dark";
      root.setAttribute("data-theme",theme);
      localStorage.setItem("bi_dashboard_theme",theme);
      const pill=document.getElementById("theme-pill");
      if(pill) pill.textContent="Modus: "+(theme==="dark"?"Dunkel":"Hell");
      updateChartTheme(theme);
    }
    function initTheme(){
      const stored=localStorage.getItem("bi_dashboard_theme")||"dark";
      applyTheme(stored);
    }

    // Login
    const loginOverlay=document.getElementById("login-overlay");
    const loginInput=document.getElementById("login-password");
    const loginButton=document.getElementById("login-button");
    const loginError=document.getElementById("login-error");
    const loginDate=document.getElementById("login-date");
    const app=document.getElementById("app");
    const logoutBtn=document.getElementById("logout-btn");

    function formatDate(d){
      return d.toLocaleDateString("de-DE",{weekday:"short",day:"2-digit",month:"2-digit",year:"numeric"});
    }
    loginDate.textContent=formatDate(new Date());
    const topbarDate=document.getElementById("topbar-date");
    topbarDate.textContent=formatDate(new Date());

    function openApp(){
      loginOverlay.style.display="none";
      app.style.display="block";
      localStorage.setItem("bi_dashboard_logged_in","1");
    }
    function handleLogin(){
      const value=(loginInput.value||"").trim();
      if(!value){ loginError.textContent="Bitte Passwort eingeben."; return; }
      if(value===PASSWORD){ loginError.textContent=""; openApp(); loadView("home"); }
      else loginError.textContent="Falsches Passwort.";
    }
    loginButton.addEventListener("click",handleLogin);
    loginInput.addEventListener("keydown",e=>{ if(e.key==="Enter") handleLogin(); });

    if(logoutBtn){
      logoutBtn.addEventListener("click",()=>{
        localStorage.removeItem("bi_dashboard_logged_in");
        location.reload();
      });
    }

    if(localStorage.getItem("bi_dashboard_logged_in")==="1"){
      openApp();
    }

    // Navigation & Views
    const navItems=document.querySelectorAll(".nav-item");
    const viewContainer=document.getElementById("view-container");
    const topbarTitle=document.getElementById("topbar-title");
    const topbarSub=document.getElementById("topbar-sub");
    const VIEW_TEXT={
      home:{title:"Dashboard",sub:"√úbersicht: Wetter, Kalender & Branchen-News."},
      portfolio:{title:"Portfolio-Cockpit",sub:"√úberblick √ºber alle Objekte & Kennzahlen (Dummy-Daten)."},
      objects:{title:"Objekte & Mieter",sub:"Objektebene mit Einheiten- & Mieter√ºbersicht."},
      projects:{title:"Projekte / Bau",sub:"Bauprojekte und Gewerke im √úberblick."},
      finance:{title:"Finanzen",sub:"Aggregierte Finanzkennzahlen aus den Objekt-Daten."},
      reports:{title:"Reports",sub:"Platzhalter f√ºr Reporting & Exporte."},
      settings:{title:"Einstellungen",sub:"Theme & System (weitere Funktionen folgen)."}
    };

    let currentView=null;

    async function loadView(viewKey){
      if(currentView===viewKey) return;
      currentView=viewKey;

      navItems.forEach(n=>{
        if(n.getAttribute("data-view")===viewKey) n.classList.add("active");
        else n.classList.remove("active");
      });

      const cfg=VIEW_TEXT[viewKey];
      if(cfg){ topbarTitle.textContent=cfg.title; topbarSub.textContent=cfg.sub; }

      viewContainer.innerHTML="";
      try{
        const res=await fetch(`view-${viewKey}.html`,{cache:"no-store"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        const html=await res.text();

        const range=document.createRange();
        const frag=range.createContextualFragment(html);

        // Styles der View in den Head ziehen
        frag.querySelectorAll("style").forEach(styleTag=>{
          document.head.appendChild(styleTag.cloneNode(true));
          styleTag.remove();
        });

        const wrapper=document.createElement("div");
        wrapper.className="module";
        wrapper.appendChild(frag);
        viewContainer.appendChild(wrapper);
      }catch(e){
        viewContainer.innerHTML=`<div class="view-root"><div class="card"><div class="card-header"><div><div class="card-title">Fehler</div><div class="card-sub">View konnte nicht geladen werden.</div></div></div><div class="summary-block">${e.message}</div></div></div>`;
        return;
      }

      if(viewKey==="home") initHomeView();
      if(viewKey==="portfolio") initPortfolioView();
      if(viewKey==="objects") initObjectsView();
      if(viewKey==="projects") initProjectsView();
      if(viewKey==="finance") initFinanceView();
      if(viewKey==="reports") {/* Platzhalter */}
      if(viewKey==="settings") initSettingsView();

      updateChartTheme(localStorage.getItem("bi_dashboard_theme")||"dark");
    }

    navItems.forEach(item=>{
      item.addEventListener("click",()=>loadView(item.getAttribute("data-view")));
    });

    // Chart-Referenzen
    let cashflowChart, rentPerObjectChart, roiPerObjectChart, vacancyChart;
    let objectRentChart, objectOccupancyChart;
    let homeCfChart, homeCfYearChart, homeRentChart, homeVacancyChart, homeRoiChart;

    // Portfolio-Init
    function initPortfolioView(){
      const objects=DATA.objects;
      const objectCount=objects.length;
      const totalMonthlyCF=objects.reduce((s,o)=>s+o.cashflowYear/12,0);
      const totalMonthlyRent=objects.reduce((s,o)=>s+o.monthlyRentActual,0);
      const totalMonthlyRentPotential=objects.reduce((s,o)=>s+o.monthlyRentPotential,0);
      const totalVacancyArea=objects.reduce((s,o)=>s+o.vacancyArea,0);
      const totalArea=objects.reduce((s,o)=>s+o.totalArea,0);
      const avgRoi=objects.reduce((s,o)=>s+o.roi,0)/objectCount;
      const totalEquity=objects.reduce((s,o)=>s+o.equity,0);
      const totalCFYear=objects.reduce((s,o)=>s+o.cashflowYear,0);
      const totalRentYear=objects.reduce((s,o)=>s+o.monthlyRentActual*12,0);

      // Tags in Portfolio-View
      const objTag=document.getElementById("portfolio-object-count-tag");
      if(objTag) objTag.textContent=objectCount+" Objekte im Portfolio";

      const kpiMonthlyCf=document.getElementById("kpi-monthly-cf");
      if(kpiMonthlyCf){
        kpiMonthlyCf.textContent=formatEuro(Math.round(totalMonthlyCF));
        document.getElementById("kpi-monthly-cf-sub").textContent="Jahres-CF: "+formatEuro(totalCFYear);
        document.getElementById("kpi-rent-total").textContent=formatEuro(totalMonthlyRent);
        document.getElementById("kpi-rent-total-sub").textContent="Potenzial: "+formatEuro(totalMonthlyRentPotential);
        document.getElementById("kpi-vacancy").textContent=formatArea(totalVacancyArea);
        const occArea=Math.max(totalArea-totalVacancyArea,0);
        const occPct=totalArea>0?(occArea/totalArea)*100:0;
        document.getElementById("kpi-vacancy-sub").textContent="Belegung: "+formatPercent(occPct);
        document.getElementById("kpi-avg-roi").textContent=formatPercent(avgRoi);
        document.getElementById("kpi-equity-total").textContent="EK gesamt: "+formatEuro(totalEquity);
      }

      // Home-KPIs (Top 5 + Charts)
      const homeCf=document.getElementById("home-kpi-cf");
      if(homeCf){
        homeCf.textContent=formatEuro(Math.round(totalMonthlyCF));
        const cfYearEl=document.getElementById("home-kpi-cf-year");
        if(cfYearEl) cfYearEl.textContent=formatEuro(totalCFYear);

        const rentEl=document.getElementById("home-kpi-rent");
        if(rentEl) rentEl.textContent=formatEuro(totalMonthlyRent);

        const vacancyRateEl=document.getElementById("home-kpi-vacancy-rate");
        if(vacancyRateEl){
          const vacancyRate=totalArea>0?(totalVacancyArea/totalArea)*100:0;
          vacancyRateEl.textContent=formatPercent(vacancyRate);
        }

        const roiPortfolioEl=document.getElementById("home-kpi-roi");
        const roiPortfolio=(totalCFYear/totalEquity)*100;
        if(roiPortfolioEl) roiPortfolioEl.textContent=formatPercent(roiPortfolio);

        // KPI-Charts
        initHomeKpiCharts({
          totalMonthlyCF,
          totalCFYear,
          totalMonthlyRent,
          totalVacancyArea,
          totalArea,
          totalEquity,
          roiPortfolio
        });
      }

      // Tabelle in Portfolio-View
      const tbody=document.getElementById("portfolio-objects-tbody");
      if(tbody){
        tbody.innerHTML="";
        objects.forEach(obj=>{
          const tr=document.createElement("tr");
          tr.style.cursor="pointer";
          tr.innerHTML=`
            <td>${obj.name}</td>
            <td>${obj.city}</td>
            <td>${formatEuro(obj.monthlyRentActual)}</td>
            <td>${obj.vacancyUnits} Einh. / ${formatArea(obj.vacancyArea)}</td>
            <td>${formatPercent(obj.roi)}</td>
            <td>${formatArea(obj.totalArea)}</td>`;
          tr.addEventListener("click",()=>{
            loadView("objects").then(()=>{
              const sel=document.getElementById("object-select");
              if(sel){ sel.value=obj.id; updateObjectDetail(obj.id); }
            });
          });
          tbody.appendChild(tr);
        });
      }

      // Portfolio-Charts
      const chartCfCanvas=document.getElementById("chart-cashflow");
      const chartRentCanvas=document.getElementById("chart-rent-per-object");
      const chartRoiCanvas=document.getElementById("chart-roi-per-object");
      const chartVacCanvas=document.getElementById("chart-vacancy");

      if(chartCfCanvas && chartRentCanvas && chartRoiCanvas && chartVacCanvas){
        initPortfolioCharts(
          objects,
          totalCFYear,
          totalArea,
          totalVacancyArea,
          chartCfCanvas,
          chartRentCanvas,
          chartRoiCanvas,
          chartVacCanvas
        );
      }
    }

    function initPortfolioCharts(objects,totalCFYear,totalArea,totalVacancyArea,cfCanvas,rentCanvas,roiCanvas,vacCanvas){
      const ctxCF=cfCanvas.getContext("2d");
      const ctxRent=rentCanvas.getContext("2d");
      const ctxROI=roiCanvas.getContext("2d");
      const ctxVac=vacCanvas.getContext("2d");

      const monthsHist=["Jan","Feb","Mrz","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];
      const monthsForecast=["+1","+2","+3","+4","+5","+6"];
      const avgMonthlyCF=totalCFYear/12;

      const cfHist=monthsHist.map((_,i)=>{
        const f=1+Math.sin(i/2)*0.15;
        return Math.round(avgMonthlyCF*f);
      });
      const last=cfHist[cfHist.length-1];
      const cfFc=monthsForecast.map((_,i)=>Math.round(last*(1+0.01*(i+1))));

      cashflowChart=new Chart(ctxCF,{
        type:"line",
        data:{
          labels:[...monthsHist,...monthsForecast],
          datasets:[
            {label:"Historie",data:[...cfHist,...Array(monthsForecast.length).fill(null)],tension:0.35,borderWidth:2,fill:true,borderColor:"#0ea568",backgroundColor:"rgba(14,165,104,0.15)"},
            {label:"Prognose",data:[...Array(monthsHist.length).fill(null),...cfFc],tension:0.35,borderWidth:2,borderDash:[5,4],fill:false,borderColor:"#f97316"}
          ]
        },
        options:{
          responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
          scales:{
            x:{ticks:{color:"#a3a6b7",font:{size:10}},grid:{color:"rgba(255,255,255,0.05)"}},
            y:{ticks:{color:"#a3a6b7",font:{size:10},callback:v=>v.toLocaleString("de-DE")},grid:{color:"rgba(255,255,255,0.05)"}}
          }
        }
      });

      const labels=objects.map(o=>o.name);
      const rentData=objects.map(o=>o.monthlyRentActual);
      rentPerObjectChart=new Chart(ctxRent,{
        type:"bar",
        data:{labels,datasets:[{data:rentData,backgroundColor:["#0ea568","#1d8bff","#ffb020"],borderWidth:1}]},
        options:{
          responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
          scales:{
            x:{ticks:{color:"#a3a6b7",font:{size:10}},grid:{display:false}},
            y:{ticks:{color:"#a3a6b7",font:{size:10},callback:v=>v.toLocaleString("de-DE")},grid:{color:"rgba(255,255,255,0.05)"}}
          }
        }
      });

      const roiData=objects.map(o=>o.roi);
      roiPerObjectChart=new Chart(ctxROI,{
        type:"bar",
        data:{labels,datasets:[{data:roiData,backgroundColor:["#22c55e","#3b82f6","#a855f7"],borderWidth:1}]},
        options:{
          responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
          scales:{
            x:{ticks:{color:"#a3a6b7",font:{size:10}},grid:{display:false}},
            y:{ticks:{color:"#a3a6b7",font:{size:10},callback:v=>v+" %"},grid:{color:"rgba(255,255,255,0.05)"}}
          }
        }
      });

      const occArea=Math.max(totalArea-totalVacancyArea,0);
      vacancyChart=new Chart(ctxVac,{
        type:"doughnut",
        data:{labels:["Belegt","Leerstand"],datasets:[{data:[occArea,totalVacancyArea],backgroundColor:["#22c55e","#94a3b8"],borderWidth:1}]},
        options:{
          responsive:true,maintainAspectRatio:false,
          plugins:{legend:{position:"bottom",labels:{color:"#a3a6b7",font:{size:10}}}},
          cutout:"60%"
        }
      });
    }

    // Objekte & Mieter
    function initObjectsView(){
      const select=document.getElementById("object-select");
      const objects=DATA.objects;
      if(!select) return;
      select.innerHTML="";
      objects.forEach(o=>{
        const opt=document.createElement("option");
        opt.value=o.id; opt.textContent=o.name;
        select.appendChild(opt);
      });
      select.addEventListener("change",()=>updateObjectDetail(select.value));
      if(objects.length){ select.value=objects[0].id; updateObjectDetail(objects[0].id); }
    }

    function updateObjectDetail(id){
      const obj=DATA.objects.find(o=>o.id===id);
      if(!obj) return;
      const meta=document.getElementById("object-meta-pill");
      const summary=document.getElementById("object-summary");
      const tbody=document.getElementById("units-tbody");
      if(meta) meta.textContent=`${obj.city} ‚Ä¢ ${formatArea(obj.totalArea)} ‚Ä¢ ROI ${formatPercent(obj.roi)}`;

      if(summary){
        const vacText=obj.vacancyUnits>0
          ?`${obj.vacancyUnits} Einheit(en) leer (${formatArea(obj.vacancyArea)})`
          :"voll vermietet";

        summary.innerHTML=`
          <strong>${obj.name}</strong> in ${obj.city}<br>
          Miete (Ist): <strong>${formatEuro(obj.monthlyRentActual)} p.m.</strong> &nbsp;‚Ä¢&nbsp;
          Potenzial: <strong>${formatEuro(obj.monthlyRentPotential)} p.m.</strong><br>
          Leerstand: <strong>${vacText}</strong><br>
          Jahres-Cashflow (Dummy): <strong>${formatEuro(obj.cashflowYear)}</strong> &nbsp;‚Ä¢&nbsp;
          EK-Einsatz (Dummy): <strong>${formatEuro(obj.equity)}</strong>
        `;
      }

      if(tbody){
        tbody.innerHTML="";
        obj.units.forEach(u=>{
          const tr=document.createElement("tr");
          const statusClass=u.status==="vermietet"?"ok":u.status==="leer"?"leer":"";
          let payBadge="";
          if(u.paymentStatus==="p√ºnktlich") payBadge=`<span class="badge-status ok">p√ºnktlich</span>`;
          else if(u.paymentStatus==="R√ºckstand") payBadge=`<span class="badge-status risky">R√ºckstand</span>`;

          tr.innerHTML=`
            <td>${u.name}</td>
            <td>${u.floor}</td>
            <td>${formatArea(u.area)}</td>
            <td>${u.status?`<span class="badge-status ${statusClass}">${u.status}</span>`:""}</td>
            <td>${u.tenant||"‚Äì"}</td>
            <td>${formatEuro(u.rent)}</td>
            <td>${formatEuro(u.nk)}</td>
            <td>${payBadge||"‚Äì"}</td>`;
          tbody.appendChild(tr);
        });
      }

      updateObjectCharts(obj);
    }

    function updateObjectCharts(obj){
      const ctxR=document.getElementById("chart-object-rent");
      const ctxO=document.getElementById("chart-object-occupancy");
      if(!ctxR || !ctxO) return;

      const ist=obj.monthlyRentActual;
      const soll=obj.monthlyRentPotential;
      const forecast=Math.round(soll*1.03);

      if(objectRentChart) objectRentChart.destroy();
      objectRentChart=new Chart(ctxR.getContext("2d"),{
        type:"bar",
        data:{labels:["Ist","Potenzial","Prognose"],datasets:[{data:[ist,soll,forecast],backgroundColor:["#0ea568","#1d8bff","#f97316"],borderWidth:1}]},
        options:{
          responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
          scales:{
            x:{ticks:{color:"#a3a6b7",font:{size:10}},grid:{display:false}},
            y:{ticks:{color:"#a3a6b7",font:{size:10},callback:v=>v.toLocaleString("de-DE")},grid:{color:"rgba(255,255,255,0.05)"}}
          }
        }
      });

      const occArea=Math.max(obj.totalArea-obj.vacancyArea,0);
      if(objectOccupancyChart) objectOccupancyChart.destroy();
      objectOccupancyChart=new Chart(ctxO.getContext("2d"),{
        type:"doughnut",
        data:{labels:["vermietet","leer"],datasets:[{data:[occArea,obj.vacancyArea],backgroundColor:["#22c55e","#94a3b8"],borderWidth:1}]},
        options:{
          responsive:true,maintainAspectRatio:false,
          plugins:{legend:{position:"bottom",labels:{color:"#a3a6b7",font:{size:10}}}},
          cutout:"60%"
        }
      });
    }

    // Projekte
    function initProjectsView(){
      const tbody=document.getElementById("projects-tbody");
      if(!tbody) return;
      tbody.innerHTML="";
      DATA.objects.forEach(obj=>{
        (obj.projects||[]).forEach(p=>{
          let cls="ok";
          if(p.status==="kritisch") cls="risky";
          if(p.status==="abgeschlossen") cls="ok";
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td>${p.name}</td>
            <td>${obj.name}</td>
            <td><span class="badge-status ${cls}">${p.status}</span></td>
            <td>${formatEuro(p.budget)}</td>
            <td>${formatEuro(p.spent)}</td>
            <td>${formatDeviation(p.deviationPercent)}</td>`;
          tbody.appendChild(tr);
        });
      });
    }

    // Finanzen
    function initFinanceView(){
      const el=document.getElementById("finance-summary");
      if(!el) return;
      const objs=DATA.objects;
      const totalCFYear=objs.reduce((s,o)=>s+o.cashflowYear,0);
      const totalEquity=objs.reduce((s,o)=>s+o.equity,0);
      const totalRentYear=objs.reduce((s,o)=>s+o.monthlyRentActual*12,0);
      const roiPortfolio=(totalCFYear/totalEquity)*100;
      el.innerHTML=`
        Basierend auf den Dummy-Daten:<br>
        ‚Ä¢ Jahres-Mieteinnahmen (Ist): <strong>${formatEuro(totalRentYear)}</strong><br>
        ‚Ä¢ Jahres-Cashflow (netto, Dummy): <strong>${formatEuro(totalCFYear)}</strong><br>
        ‚Ä¢ Eingesetztes Eigenkapital: <strong>${formatEuro(totalEquity)}</strong><br>
        ‚Ä¢ Portfolio-ROI (Cash-on-Cash, Dummy): <strong>${formatPercent(roiPortfolio)}</strong>`;
    }

    // ===== HOME VIEW: Wetter, Kalender, News, KPI-Charts =====
    function initHomeView(){
      loadWeather();
      buildCalendar();
      loadNews();
      initPortfolioView(); // speist die KPIs + Charts
    }

    function weatherCodeToIcon(code){
      if(code===0) return "‚òÄÔ∏è";
      if([1,2].includes(code)) return "üå§Ô∏è";
      if(code===3) return "‚òÅÔ∏è";
      if([45,48].includes(code)) return "üå´Ô∏è";
      if([51,53,55,56,57].includes(code)) return "üå¶Ô∏è";
      if([61,63,65,80,81,82].includes(code)) return "üåßÔ∏è";
      if([71,73,75,85,86].includes(code)) return "‚ùÑÔ∏è";
      if([95,96,99].includes(code)) return "‚õàÔ∏è";
      return "‚ÑπÔ∏è";
    }

    function fetchWeatherForCoords(lat,lon){
      const tag=document.getElementById("weather-location-tag");
      const cont=document.getElementById("weather-content");
      if(!tag || !cont) return;

      const url="https://api.open-meteo.com/v1/forecast?latitude="+lat+"&longitude="+lon+"&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&forecast_days=7&timezone=auto";

      fetch(url)
        .then(r=>r.json())
        .then(data=>{
          const cw=data.current_weather;
          const daily=data.daily;
          if(!cw || !daily) throw new Error("keine Wetterdaten");

          // Standort-Anzeige
          tag.textContent=`Dein Standort (${cw.temperature.toFixed(1)}¬∞C)`;

          const mainIcon=weatherCodeToIcon(cw.weathercode);
          const now=new Date(cw.time);
          const timeStr=now.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});

          const daysHtml=daily.time.map((iso,idx)=>{
            const d=new Date(iso);
            const dayName=d.toLocaleDateString("de-DE",{weekday:"short"});
            const icon=weatherCodeToIcon(daily.weathercode[idx]);
            const tmax=daily.temperature_2m_max[idx].toFixed(0);
            const tmin=daily.temperature_2m_min[idx].toFixed(0);
            return `
              <div class="weather-day-card">
                <div class="weather-day-name">${dayName}</div>
                <div class="weather-day-icon">${icon}</div>
                <div class="weather-day-temp">${tmax}¬∞ / ${tmin}¬∞</div>
              </div>`;
          }).join("");

          cont.innerHTML=`
            <div class="weather-hero">
              <div>
                <div class="weather-main-temp">${cw.temperature.toFixed(1)}¬∞C ${mainIcon}</div>
                <div class="weather-main-meta">
                  Aktualisiert: ${timeStr} ‚Ä¢ Code ${cw.weathercode}
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:8px;">
                <div class="wind-compass">
                  <div class="wind-compass-arrow" id="wind-arrow"></div>
                  N
                </div>
                <div style="font-size:11px;color:var(--text-soft);">
                  <div>Wind: ${cw.windspeed.toFixed(0)} km/h</div>
                  <div>Richtung: ${cw.winddirection}¬∞</div>
                </div>
              </div>
            </div>

            <div class="weather-row">
              <span>üå°Ô∏è <strong>${cw.temperature.toFixed(1)}¬∞C</strong></span>
              <span>üí® ${cw.windspeed.toFixed(0)} km/h</span>
              <span>‚åö ${timeStr}</span>
            </div>

            <div class="weather-forecast-grid">
              ${daysHtml}
            </div>
          `;

          const arrow=document.getElementById("wind-arrow");
          if(arrow){
            arrow.style.transform=`rotate(${cw.winddirection}deg)`;
          }
        })
        .catch(()=>{
          tag.textContent="Wetter (Fallback)";
          cont.innerHTML=`
            <div class="weather-hero">
              <div>
                <div class="weather-main-temp">‚Äì¬∞C</div>
                <div class="weather-main-meta">Wetterdaten aktuell nicht abrufbar.</div>
              </div>
            </div>`;
        });
    }

    function loadWeather(){
      if(!navigator.geolocation){
        // Fallback: Ganderkesee
        fetchWeatherForCoords(53.03,8.54);
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos=>{
          const {latitude,longitude}=pos.coords;
          fetchWeatherForCoords(latitude,longitude);
        },
        ()=>{
          // User verweigert / Fehler: Ganderkesee
          fetchWeatherForCoords(53.03,8.54);
        },
        {enableHighAccuracy:false,timeout:5000,maximumAge:300000}
      );
    }

    function isGermanHolidayNI(year,month,day){
      const fixed=[
        {m:0,d:1},   // Neujahr
        {m:4,d:1},   // 1. Mai
        {m:9,d:3},   // Tag der Einheit
        {m:9,d:31},  // Reformationstag (NI)
        {m:11,d:25}, // 1. Weihnachtstag
        {m:11,d:26}  // 2. Weihnachtstag
      ];
      return fixed.some(h=>h.m===month && h.d===day);
    }

    function updateRentCounter(){
      const el=document.getElementById("rent-counter");
      if(!el) return;
      const today=new Date();
      let year=today.getFullYear();
      let month=today.getMonth();
      let next=new Date(year,month,1);
      if(today > next){
        month += 1;
        next=new Date(year,month,1);
      }
      const diffMs=next - today;
      const diffDays=Math.ceil(diffMs/86400000);
      const mm=(next.getMonth()+1).toString().padStart(2,"0");
      const yyyy=next.getFullYear();
      el.textContent=`N√§chste Mieteinnahmen in ${diffDays} Tag${diffDays===1?"":"en"} (01.${mm}.${yyyy})`;
    }

    function buildCalendar(){
      const header=document.getElementById("calendar-header");
      const grid=document.getElementById("calendar-grid");
      if(!header||!grid) return;
      const today=new Date();
      const year=today.getFullYear();
      const month=today.getMonth();
      const monthName=today.toLocaleString("de-DE",{month:"long"});
      header.textContent=`${monthName} ${year}`;
      grid.innerHTML="";

      const weekdays=["Mo","Di","Mi","Do","Fr","Sa","So"];
      weekdays.forEach(d=>{
        const cell=document.createElement("div");
        cell.className="calendar-cell head";
        cell.textContent=d;
        grid.appendChild(cell);
      });

      const first=new Date(year,month,1);
      const start=(first.getDay()+6)%7; // Montag = 0
      for(let i=0;i<start;i++){
        const empty=document.createElement("div");
        empty.className="calendar-cell";
        grid.appendChild(empty);
      }

      const days=new Date(year,month+1,0).getDate();
      for(let d=1;d<=days;d++){
        const cell=document.createElement("div");
        cell.className="calendar-cell";
        cell.textContent=d;

        const date=new Date(year,month,d);
        const jsDay=date.getDay(); // 0=So,6=Sa
        const weekend=jsDay===0 || jsDay===6;
        const holiday=isGermanHolidayNI(year,month,d);

        if(d===today.getDate()) cell.classList.add("today");
        if(weekend) cell.classList.add("weekend");
        if(holiday) cell.classList.add("holiday");

        if(d===1){
          cell.classList.add("rent-day");
        }

        grid.appendChild(cell);
      }

      updateRentCounter();
    }

    function loadNews(){
      const statusEl=document.getElementById("news-status");
      const listEl=document.getElementById("news-list");
      if(!statusEl||!listEl) return;
      const fallback=[
        {
          title:"Dummy: Mietpreisentwicklungen im Nordwesten",
          link:"https://www.immobilien-zeitung.de/",
          snippet:"Aktuelle Entwicklungen der Wohnungsmieten im Raum Bremen / Oldenburg mit Fokus auf Bestands- und Neubauprojekte."
        },
        {
          title:"Dummy: F√∂rderprogramme f√ºr energetische Sanierungen",
          link:"https://www.kfw.de/",
          snippet:"√úberblick √ºber relevante KfW-Programme f√ºr energetische Modernisierung von Wohngeb√§uden und Mehrfamilienh√§usern."
        },
        {
          title:"Dummy: Entwicklung Baukostenindex Deutschland",
          link:"https://www.destatis.de/",
          snippet:"Kurzer Abriss zur Entwicklung von Bau- und Materialkosten im bundesweiten Vergleich ‚Äì wichtig f√ºr Projektkalkulationen."
        }
      ];
      function render(items){
        listEl.innerHTML="";
        items.forEach(n=>{
          const li=document.createElement("li");
          li.className="news-item";
          li.innerHTML=`
            <div class="news-headline">
              <a href="${n.link}" target="_blank" rel="noopener">${n.title}</a>
            </div>
            <div class="news-snippet">${n.snippet}</div>`;
          listEl.appendChild(li);
        });
      }

      const rssProxy="https://api.allorigins.win/get?url="+encodeURIComponent("https://www.immobilien-zeitung.de/rss");

      fetch(rssProxy)
        .then(r=>r.json())
        .then(data=>{
          if(!data || !data.contents) throw new Error("kein RSS");
          const parser=new DOMParser();
          const xml=parser.parseFromString(data.contents,"text/xml");
          const items=Array.from(xml.querySelectorAll("item")).slice(0,5);
          const news=items.map(it=>{
            const title=it.querySelector("title")?.textContent||"News";
            const link=it.querySelector("link")?.textContent||"#";
            const desc=it.querySelector("description")?.textContent||"";
            const clean=desc.replace(/<\/?[^>]+(>|$)/g,"").replace(/\s+/g," ").trim();
            const snippet=clean.length>220?clean.slice(0,220)+"‚Ä¶":clean;
            return {title,link,snippet};
          });
          if(!news.length) throw new Error("keine Items");
          statusEl.textContent="Live";
          render(news);
        })
        .catch(()=>{
          statusEl.textContent="Fallback";
          render(fallback);
        });
    }

    // KPI-Charts auf der Home-View
    function initHomeKpiCharts({totalMonthlyCF,totalCFYear,totalMonthlyRent,totalVacancyArea,totalArea,totalEquity,roiPortfolio}){
      const cfCanvas=document.getElementById("chart-home-cf");
      const cfYearCanvas=document.getElementById("chart-home-cf-year");
      const rentCanvas=document.getElementById("chart-home-rent");
      const vacCanvas=document.getElementById("chart-home-vacancy");
      const roiCanvas=document.getElementById("chart-home-roi");

      const now=new Date();
      const monthLabels=[];
      for(let i=5;i>=0;i--){
        const d=new Date(now.getFullYear(),now.getMonth()-i,1);
        monthLabels.push(d.toLocaleString("de-DE",{month:"short"}));
      }
      const futureLabels=["+1","+2","+3"];

      // Monats-CF: 6M History + 3M Forecast
      if(cfCanvas){
        const hist=monthLabels.map((_,idx)=>{
          const factor=1+Math.sin(idx/2)*0.1;
          return Math.round((totalMonthlyCF||1)*factor);
        });
        const last=hist[hist.length-1]||totalMonthlyCF;
        const forecast=futureLabels.map((_,i)=>Math.round(last*(1+0.01*(i+1))));
        if(homeCfChart) homeCfChart.destroy();
        homeCfChart=new Chart(cfCanvas.getContext("2d"),{
          type:"line",
          data:{
            labels:[...monthLabels,...futureLabels],
            datasets:[
              {label:"Historie",data:[...hist,...Array(futureLabels.length).fill(null)],tension:0.35,borderWidth:1.8,fill:true,borderColor:"#0ea568",backgroundColor:"rgba(14,165,104,0.15)"},
              {label:"Forecast",data:[...Array(monthLabels.length).fill(null),...forecast],tension:0.35,borderWidth:1.5,borderDash:[4,3],fill:false,borderColor:"#f97316"}
            ]
          },
          options:{
            responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
            scales:{
              x:{ticks:{font:{size:9}},grid:{display:false}},
              y:{ticks:{font:{size:9},callback:v=>v.toLocaleString("de-DE")},grid:{color:"rgba(148,163,184,0.25)"}}
            }
          }
        });
      }

      // Jahres-CF: 4 Jahre Historie + 2 Jahre Forecast
      if(cfYearCanvas){
        const years=[];
        const cfHist=[];
        const baseYear=now.getFullYear()-3;
        for(let i=0;i<4;i++){
          years.push((baseYear+i).toString().slice(-2));
          const factor=0.85+0.07*i;
          cfHist.push(Math.round(totalCFYear*factor));
        }
        const lastYearVal=cfHist[cfHist.length-1]||totalCFYear;
        const cfForecast=[Math.round(lastYearVal*1.03),Math.round(lastYearVal*1.06)];
        const yearLabels=[...years,"+1","+2"];
        if(homeCfYearChart) homeCfYearChart.destroy();
        homeCfYearChart=new Chart(cfYearCanvas.getContext("2d"),{
          type:"bar",
          data:{
            labels:yearLabels,
            datasets:[
              {data:[...cfHist,...cfForecast],backgroundColor:(ctx)=>{
                const idx=ctx.dataIndex;
                return idx<cfHist.length ? "#2563eb" : "#f97316";
              },borderWidth:0}
            ]
          },
          options:{
            responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
            scales:{
              x:{ticks:{font:{size:9}},grid:{display:false}},
              y:{ticks:{font:{size:9},callback:v=>v.toLocaleString("de-DE")},grid:{color:"rgba(148,163,184,0.25)"}}
            }
          }
        });
      }

      // Miete (p.m.): 6M History + 3M Forecast
      if(rentCanvas){
        const hist=monthLabels.map((_,idx)=>{
          const factor=1+0.005*idx;
          return Math.round(totalMonthlyRent*factor);
        });
        const last=hist[hist.length-1]||totalMonthlyRent;
        const forecast=futureLabels.map((_,i)=>Math.round(last*(1+0.003*(i+1))));
        if(homeRentChart) homeRentChart.destroy();
        homeRentChart=new Chart(rentCanvas.getContext("2d"),{
          type:"line",
          data:{
            labels:[...monthLabels,...futureLabels],
            datasets:[
              {label:"Historie",data:[...hist,...Array(futureLabels.length).fill(null)],tension:0.3,borderWidth:1.8,fill:false,borderColor:"#22c55e"},
              {label:"Forecast",data:[...Array(monthLabels.length).fill(null),...forecast],tension:0.3,borderWidth:1.5,borderDash:[4,3],borderColor:"#0ea5e9"}
            ]
          },
          options:{
            responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
            scales:{
              x:{ticks:{font:{size:9}},grid:{display:false}},
              y:{ticks:{font:{size:9},callback:v=>v.toLocaleString("de-DE")},grid:{color:"rgba(148,163,184,0.25)"}}
            }
          }
        });
      }

      // Leerstandsquote
      if(vacCanvas){
        const baseRate=totalArea>0?(totalVacancyArea/totalArea)*100:0;
        const hist=monthLabels.map((_,idx)=>{
          const jitter=(idx-2)*0.3;
          return Math.max(0,baseRate + jitter);
        });
        const last=hist[hist.length-1]||baseRate;
        const forecast=futureLabels.map((_,i)=>Math.max(0,last-0.2*(i+1)));
        if(homeVacancyChart) homeVacancyChart.destroy();
        homeVacancyChart=new Chart(vacCanvas.getContext("2d"),{
          type:"line",
          data:{
            labels:[...monthLabels,...futureLabels],
            datasets:[
              {label:"Leerstand",data:[...hist,...forecast],tension:0.35,borderWidth:1.8,fill:true,borderColor:"#f97316",backgroundColor:"rgba(249,115,22,0.12)"}
            ]
          },
          options:{
            responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
            scales:{
              x:{ticks:{font:{size:9}},grid:{display:false}},
              y:{ticks:{font:{size:9},callback:v=>v.toFixed(1)+"%"},grid:{color:"rgba(148,163,184,0.25)"}}
            }
          }
        });
      }

      // ROI
      if(roiCanvas){
        const hist=[];
        const years=[];
        const baseYear=now.getFullYear()-3;
        for(let i=0;i<4;i++){
          years.push((baseYear+i).toString().slice(-2));
          const factor=0.9+0.03*i;
          hist.push(roiPortfolio*factor);
        }
        const last=hist[hist.length-1]||roiPortfolio;
        const forecast=[last*1.02,last*1.04];
        const labels=[...years,"+1","+2"];
        if(homeRoiChart) homeRoiChart.destroy();
        homeRoiChart=new Chart(roiCanvas.getContext("2d"),{
          type:"bar",
          data:{
            labels,
            datasets:[
              {data:[...hist,...forecast],backgroundColor:(ctx)=>{
                const idx=ctx.dataIndex;
                return idx<hist.length ? "#a855f7" : "#22c55e";
              },borderWidth:0}
            ]
          },
          options:{
            responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
            scales:{
              x:{ticks:{font:{size:9}},grid:{display:false}},
              y:{ticks:{font:{size:9},callback:v=>v.toFixed(1)+"%"},grid:{color:"rgba(148,163,184,0.25)"}}
            }
          }
        });
      }
    }

    // Chart-Theme
    function updateChartTheme(theme){
      const isDark=theme!=="light";
      const axis=isDark?"#a3a6b7":"#4b5563";
      const grid=isDark?"rgba(148,163,184,0.3)":"rgba(209,213,219,0.7)";
      const legend=axis;
      const charts=[
        cashflowChart,rentPerObjectChart,roiPerObjectChart,vacancyChart,
        objectRentChart,objectOccupancyChart,
        homeCfChart,homeCfYearChart,homeRentChart,homeVacancyChart,homeRoiChart
      ];
      charts.forEach(ch=>{
        if(!ch) return;
        if(ch.options.scales){
          if(ch.options.scales.x){
            ch.options.scales.x.ticks.color=axis;
            if(ch.options.scales.x.grid) ch.options.scales.x.grid.color=grid;
          }
          if(ch.options.scales.y){
            ch.options.scales.y.ticks.color=axis;
            if(ch.options.scales.y.grid) ch.options.scales.y.grid.color=grid;
          }
        }
        if(ch.options.plugins&&ch.options.plugins.legend&&ch.options.plugins.legend.labels){
          ch.options.plugins.legend.labels.color=legend;
        }
        ch.update();
      });
    }

    // Settings
    function initSettingsView(){
      const btnDark=document.getElementById("btn-theme-dark");
      const btnLight=document.getElementById("btn-theme-light");
      if(btnDark) btnDark.onclick=()=>applyTheme("dark");
      if(btnLight) btnLight.onclick=()=>applyTheme("light");
    }

    // Theme-Toggle im Topbar
    const themePill=document.getElementById("theme-pill");
    if(themePill){
      themePill.addEventListener("click",()=>{
        const cur=document.documentElement.getAttribute("data-theme")||"dark";
        applyTheme(cur==="dark"?"light":"dark");
      });
    }

    // Start
    window.addEventListener("load",()=>{
      initTheme();
      if(localStorage.getItem("bi_dashboard_logged_in")==="1"){
        loadView("home");
      }
    });
  </script>
</body>
</html>